/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{_ as y,ad as pt,r as o,o as c,c as k,h as b,l as v,w as n,b as l,G as C,d as g,a as m,V as mt,z as x,J as T,H as ft,u as kt,ae as S,Z as wt,t as bt,p as vt,e as yt,__tla as Ct}from"./index.84d84090.3_3_0_0.js";import{C as gt,D as xt,_ as _t,s as D,a as Dt,K as Tt,L as St,F as Lt,b as Ft,__tla as $t}from"./LicenseMixin.1fc445e6.3_3_0_0.js";import{C as L,__tla as Et}from"./ChartDataController.a765a4e0.3_3_0_0.js";import{L as Pt,V as Wt,a as At,__tla as It}from"./VitalsDisabled.f093ed15.3_3_0_0.js";import{s as Vt,m as Bt,f as Ot,t as Mt,a as Ut,c as Rt,h as jt,d as Gt,j as F,k as Kt,l as zt}from"./chartHelpers.1bf67333.3_3_0_0.js";import{T as Nt,__tla as Ht}from"./TimeFramePicker.465b75eb.3_3_0_0.js";import{o as qt}from"./TimeFrames.25a2a20b.3_3_0_0.js";import{v as Jt}from"./vitalsGroup.41ed9564.3_3_0_0.js";import{__tla as Zt}from"./monaco-editor.90904fcf.3_3_0_0.js";import"./icon-help.699f8c28.3_3_0_0.js";let $,Qt=Promise.all([(()=>{try{return Ct}catch{}})(),(()=>{try{return $t}catch{}})(),(()=>{try{return Et}catch{}})(),(()=>{try{return It}catch{}})(),(()=>{try{return Ht}catch{}})(),(()=>{try{return Zt}catch{}})()]).then(async()=>{const E={name:"WorkspaceStatusCodesChart",components:{ChartComplexHeader:gt,LineChart:Pt,DashboardChartTooltip:xt,VitalsEmptyState:Wt},extends:_t,props:{stacked:{type:Boolean,default:!0},chartBackgroundColor:{type:String,default:null},padding:{type:Object,default:()=>({top:0,bottom:0,right:0,left:0})},showEmptyState:{type:Boolean,default:!1},workspace:{type:String,default:""}},data(){return{counters:{},options:{layout:{},animation:{duration:0},plugins:{legend:{display:!1,position:"top"},tooltip:{enabled:!1,mode:"index",intersect:!1,titleFont:{size:8},bodyFont:{size:8},caretSize:0,caretPadding:0,xPadding:0,itemSort:(t,e)=>t.datasetIndex>e.datasetIndex?-1:t.datasetIndex<e.datasetIndex?1:0,external:this.drawTooltip,callbacks:{label:this.formatTooltipLabel}}},elements:{point:{radius:0,hitRadius:4,hoverRadius:4}},scales:{xAxes:[{grid:{display:!1,drawTicks:!1,drawBorder:!1},ticks:{callback:this.timeTicksFormat,padding:10,source:"labels",autoSkip:!1,display:!0},type:"time",time:{parser:this.timeParser,tooltipFormat:"h:mm:ss a",displayFormats:{second:"h:mm:ss a",minute:"h:mm:ss a"}}}],yAxes:[{ticks:{maxTicksLimit:10,display:!0},id:"y-axis-main",stacked:!0,grid:{drawBorder:!1,display:!1,drawTicks:!1}}]},responsive:!0,maintainAspectRatio:!1}}},computed:{stats:Vt,meta:Bt,formattedTotal:Ot,timestampKeys:Mt,legend(){return!this.chartData||!this.chartData.datasets?[]:this.chartData.datasets.reduce((t,e)=>(t.push({color:D[e.label][0],label:`Status ${e.label}`,count:e.data.reduce((a,{y:r})=>a+r,0)}),t),[])},chartAriaLabel(){var a,r,i,s;const t=[`Line chart showing the number of requests in the ${this.workspace} workspace`],e=(r=(a=this.timeFrame)==null?void 0:a.text)==null?void 0:r.toLowerCase();if(e){t.push(`in ${e}.`);const u=[];(s=(i=this.chartData)==null?void 0:i.datasets)==null||s.forEach(h=>{const f=h.data.reduce((w,p)=>{const d={...w};return(!d.min||d.min.y>p.y)&&(d.min=p),(!d.max||d.max.y<p.y)&&(d.max=p),d},{min:null,max:null});if(f.max){const w=pt(f.max.x*1e3),p=this.isUtc?w.utc().format("LT UTC on LL"):w.format("LT on LL"),d=f.max.y%1===0?Number.parseInt(f.max.y):f.max.y;u.push(`As for ${h.label} statuses, the most recent maximum value ${d} appears at ${p}.`)}}),t.push(u.join(" "))}return t.join(" ")},chartCanvasAttrs(){return{role:"img","aria-label":this.chartAriaLabel,"aria-live":"polite"}}},mounted(){this.options.scales.yAxes[0].stacked=this.stacked,this.options.layout.padding=this.padding||{top:0,bottom:0,right:0,left:0}},methods:{toCommaNumberStr:Ut,getColor(t,e){const a=`${t.charAt(0)}xx`,r=D[a];return r?e?r[1]:r[0]:this.colors.nonStandard},formatTooltipLabel:Rt,isNonStandardClass(t){return!D[t]},getChartData:jt,tooltipTitle(t){return`Traffic ${(t&&t.dataPoints?t.dataPoints.reduce((e,a)=>{const r=parseInt(a.formattedValue);return r&&(e+=r),e},0):0).toLocaleString("en")}`}}},P={class:"row"},W={key:0,class:"no-data"},A=m("p",null,"No data available",-1),I=[A],V={key:0},B=g(" Add a Gateway Service "),O=g(" to see its traffic here "),M={key:2,class:"w-100"};function U(t,e,a,r,i,s){const u=o("router-link"),h=o("RbacValidate"),f=o("VitalsEmptyState"),w=o("ChartComplexHeader"),p=o("LineChart"),d=o("DashboardChartTooltip");return c(),k("div",P,[t.rawData&&!s.stats&&!a.showEmptyState?(c(),k("div",W,I)):b("",!0),a.showEmptyState&&!s.stats?(c(),v(f,{key:1},{message:n(()=>[l(h,{workspace:a.workspace,restricted:[{path:"/services",actions:["create"]}]},{default:n(({isAllowed:_})=>[_?(c(),k("div",V,[l(u,{to:{name:"create-service",params:{workspace:a.workspace}}},{default:n(()=>[B]),_:1},8,["to"]),O])):b("",!0)]),_:1},8,["workspace"])]),_:1})):(c(),k("div",M,[l(w,{legend:s.legend,class:"px-4 pb-4",title:"Total traffic"},{extra:n(()=>[C(t.$slots,"extra")]),_:3},8,["legend"]),l(p,{"chart-background-color":a.chartBackgroundColor,height:t.height,"chart-data":t.chartData,"canvas-attrs":s.chartCanvasAttrs,options:i.options,class:"col-12 mb-2"},null,8,["chart-background-color","height","chart-data","canvas-attrs","options"]),l(d,{"tooltip-model":t.tooltipModel,title:s.tooltipTitle},null,8,["tooltip-model","title"])]))])}const R={name:"WorkspaceStatusCodesWrapper",components:{WorkspaceStatusCodesChart:y(E,[["render",U]]),VitalsDisabled:At},mixins:[L],props:{chartDataUrls:{type:Object,default:()=>({})},statusCodeDetailRoute:{type:String,default:""},infoTexts:{type:Object,default:()=>({})},workspaceTimeFrame:{type:Object,default:null},workspaceIsUtc:{type:Boolean,default:!1},showEmptyVitals:{type:Boolean,default:!1}},data(){return{chartWrapperClass:null,percentListWrapperClass:null,chartBackgroundColor:null,height:250,timeBlock:{param:"minutes",refreshInterval:9999999,stepSize:60,text:"",ticksMod:7200,timeFrameLength:43200},stacked:!0,padding:{top:0,bottom:0,right:0,left:0},percentListOptions:{category:{text:"Status Code",key:"title"},value:{text:"Count",key:"count"}},statusCodesList:[],codeClassDescriptions:{"1xx":"Informational","2xx":"Success","3xx":"Redirection","4xx":"Client Errors","5xx":"Server Errors"},charts:{statusCodes:{url:null,rawData:null,chartData:null},codeDetail:{url:null,rawData:null}}}},computed:{statusCode(){return this.$route.params.statusCode},chartKeys(){return this.statusCode?["codeDetail"]:["statusCodes"]},infoText(){const t=this.infoTexts[this.chartKeys];return typeof t=="function"?t(this.statusCode):t},titleStyle(){return{cursor:this.statusCode?"pointer":"auto"}}},watch:{chartKeys:{handler(){this.fetchData()},deep:!0},workspaceTimeFrame:{handler(){this.timeFrame=this.workspaceTimeFrame}},workspaceIsUtc:{handler(){this.isUtc=this.workspaceIsUtc}}},mounted(){this.chartDataUrls&&(this.charts.statusCodes.url=this.chartDataUrls.statusCodes,this.charts.codeDetail.url=this.chartDataUrls.codeDetail)},methods:{backToStatusCodes(){!this.statusCode||(this.$router.replace({path:this.$route.path.replace(`/code/${this.statusCode}`,"")}),this.fetchData())},handleChartData(t){this.formatPercentList(t.datasets)},viewStatusCodeDetails({title:t}){this.statusCodeDetailRoute&&(this.$router.replace({name:this.statusCodeDetailRoute,params:{statusCode:t}}),this.fetchData())},formatPercentList(t){this.statusCodesList=t.map(e=>{const a={color:e.backgroundColor,title:e.label,count:e.data.reduce((r,{y:i})=>(r+=i,r),0)};return this.codeClassDescriptions[e.label]&&(a.subTitle=" \u2014 "+this.codeClassDescriptions[e.label]),a})}}},j={key:0,class:"row"};function G(t,e,a,r,i,s){const u=o("VitalsDisabled"),h=o("WorkspaceStatusCodesChart");return c(),k("section",null,[l(u,{"vitals-enabled":t.vitalsEnabled,"has-background":"",class:"workspace-vitals-disabled dashboard-message"},null,8,["vitals-enabled"]),!s.statusCode&&t.vitalsEnabled?(c(),k("div",j,[m("div",{class:mt([i.chartWrapperClass,"col-12 mb-2"])},[l(h,{"show-empty-state":a.showEmptyVitals,workspace:t.workspace,padding:i.padding,"chart-background-color":i.chartBackgroundColor,stacked:i.stacked,"vitals-enabled":t.vitalsEnabled,height:i.height,"time-frame":t.timeFrame,"is-utc":t.isUtc,"raw-data":i.charts.statusCodes.rawData,onChartData:s.handleChartData},{extra:n(()=>[C(t.$slots,"extra",{},void 0,!0)]),_:3},8,["show-empty-state","workspace","padding","chart-background-color","stacked","vitals-enabled","height","time-frame","is-utc","raw-data","onChartData"])],2)])):b("",!0),C(t.$slots,"statusCodeDetail",{statusCode:s.statusCode,timeFrame:t.timeFrame,vitalsEnabled:t.vitalsEnabled,rawData:i.charts.codeDetail.rawData},void 0,!0)])}const K=y(R,[["render",G],["__scopeId","data-v-6465e91e"]]),z={name:"WorkspaceStatusCodesOverview",extends:K,props:{chartDataUrls:{type:Object,default:()=>({statusCodes:"status_code_classes"})},infoTexts:{type:Object,default:()=>({statusCodes:Gt.statusCodesWorkspace})}},data(){return{padding:null,chartBackgroundColor:null,chartWrapperClass:"col-lg-12 flex-lg-last",percentListWrapperClass:"col-lg-12 flex-lg-first",stacked:!0,height:250}},computed:{...x(T,["workspace"])}},N={name:"ThrouputWidget",components:{WorkspaceStatusCodesOverview:z,DashboardWidget:Dt},props:{timeFrame:{type:Object,default:null},isUtc:{type:Boolean,default:!1},showEmptyVitals:{type:Boolean,default:!1},noBorder:{type:Boolean,default:!1}},data(){return{title:"Total Traffic"}}};function H(t,e,a,r,i,s){const u=o("WorkspaceStatusCodesOverview"),h=o("DashboardWidget");return c(),v(h,{"no-border":a.noBorder},{content:n(()=>[l(u,{"show-empty-vitals":a.showEmptyVitals,"workspace-time-frame":a.timeFrame,"workspace-is-utc":a.isUtc},{extra:n(()=>[C(t.$slots,"extra")]),_:3},8,["show-empty-vitals","workspace-time-frame","workspace-is-utc"])]),_:3},8,["no-border"])}const q=y(N,[["render",H]]),J={name:"WorkspaceDashboard",components:{PageHeader:ft,KMetricTabs:Tt,LicenseGrid:St,ThroughputWidget:q,TimeFramePicker:Nt,FreeModeCTA:Lt},mixins:[L,Ft],data(){return{totalConsumers:null,totalServices:null,charts:{vitalsGroup:{url:"status_code_classes",rawData:null,config:Jt}},isWidgetVisible:{services:!0,consumers:!0,plugins:!0,portal:!0,vitals:!0},timeFrameOptions:qt}},computed:{...x(kt,{perms:"permissions"}),...x(T,["workspace"]),...x(wt,{workspacesEnabled:t=>t.mode===S.FULL,isFreeMode:t=>t.mode===S.FREE}),licenseGridMetrics(){return{license:{metric:"License expiration",value:Math.floor(this.licenseExpirationDays),total:Math.floor(this.licenseTotalDays)},others:{totalServices:{metric:"API services",helpText:"The total number of Gateway Services configured in this workspace.",value:this.totalServices},totalConsumers:{metric:"API consumers",helpText:"The total number of Consumers configured in this workspace.",value:this.totalConsumers}}}},showEmptyVitals(){return this.totalServices===null||this.totalServices===0},hasInfoPermission(){return this.$rbac.isAllowed(this.perms,[{path:"/kong",actions:["read"]}],this.workspace)},hasVitalsPermissions(){return this.$rbac.isAllowed(this.perms,[{path:"/vitals/cluster",actions:["read"]},{path:"/vitals/status_code_classes",actions:["read"]}],this.workspace)},averageErrorRate(){const{rawData:t}=this.charts.vitalsGroup;if(!t||!t.stats.cluster)return"0%";const e=F(Object.values(t.stats.cluster)),a=Kt(Object.values(t.stats.cluster)),r=zt(e,a);return isNaN(r)?"0%":`${r.toFixed(2)}%`},workspaceMetrics(){const{rawData:t}=this.charts.vitalsGroup;let e="0";return t&&t.stats.cluster&&(e=F(Object.values(t.stats.cluster)).toString()),Object.values({totalRequests:{slot:!0,tip:"The total number of API requests proxied through Kong in the selected time frame.",hash:"traffic",metric:"Total traffic",value:e,status:"info"}}).map(a=>({hash:a.hash,tip:a.tip,title:a.metric,value:a,status:a.status}))}},watch:{workspace:function(t){t&&this.countTotalConsumers()}},mounted(){this.countTotalConsumers(),this.fetchLicenseInfo()},methods:{async fetchLicenseInfo(){const t=await this.$api.getLicenseReport();this.licenseReport=t.data},navigateToSettings(){this.$router.push({name:"edit-workspace",params:{workspace:this.workspace,returnLink:this.$route.fullPath}})},async countTotalConsumers(){let t=null,e=null;if(this.$rbac.isAllowed(this.perms,[{path:`/workspaces/${this.workspace}/meta`,actions:["read"]}],this.workspace))try{const a=await this.$api.query(`${this.workspace}/workspaces/${this.workspace}/meta`);t=a.data.counts.consumers||0,e=a.data.counts.services||0}catch(a){t="--",e="--",console.log(a)}this.totalConsumers=t,this.totalServices=e}}},Z=t=>(vt("data-v-c6679b92"),t=t(),yt(),t),Q={key:0,class:"dashboard container-fluid"},X={class:"row"},Y={class:"col"},tt=g(" Settings "),at=Z(()=>m("hr",{class:"mb-6"},null,-1)),et={key:0,class:"row"},st={class:"col"},rt={key:1,class:"row"},ot={class:"col"},it={class:"dashboard-control d-flex flex-wrap"},lt={style:{color:"var(--red-500)"}},ct=g(" Average error rate ");function nt(t,e,a,r,i,s){const u=o("KIcon"),h=o("KButton"),f=o("PageHeader"),w=o("LicenseGrid"),p=o("KCard"),d=o("RbacEmptyList"),_=o("TimeFramePicker"),dt=o("ThroughputWidget"),ut=o("KMetricTabs"),ht=o("FreeModeCTA");return t.workspace?(c(),k("section",Q,[m("div",X,[m("div",Y,[l(f,{size:2,title:`Workspace: ${t.workspace}`},{default:n(()=>[t.workspacesEnabled?(c(),v(h,{key:0,appearance:"outline",class:"ml-2 mb-2",onClick:s.navigateToSettings},{icon:n(()=>[l(u,{icon:"gear","view-box":"0 0 16 16",color:"#1155cb"})]),default:n(()=>[tt]),_:1},8,["onClick"])):b("",!0)]),_:1},8,["title"])])]),at,l(p,{class:"mb-6","data-testid":"overview-card",title:"Overview"},{body:n(()=>[l(w,{"license-metric":s.licenseGridMetrics.license,"other-metrics":s.licenseGridMetrics.others,"metric-slots":4,"hide-license":""},null,8,["license-metric","other-metrics"])]),_:1}),!s.hasInfoPermission||!t.isFreeMode&&!s.hasVitalsPermissions?(c(),k("div",et,[m("div",st,[l(d)])])):!t.isFreeMode&&s.hasVitalsPermissions?(c(),k("div",rt,[m("div",ot,[l(ut,{tabs:s.workspaceMetrics},{actions:n(()=>[m("div",it,[s.hasVitalsPermissions?(c(),v(_,{key:0,"update-controls":t.updateControls,"is-disabled":!t.vitalsEnabled,options:i.timeFrameOptions},null,8,["update-controls","is-disabled","options"])):b("",!0)])]),traffic:n(()=>[l(dt,{"show-empty-vitals":s.showEmptyVitals,"time-frame":t.timeFrame,"is-utc":t.isUtc,"no-border":""},{extra:n(()=>[m("div",lt,[m("b",null,bt(s.averageErrorRate),1),ct])]),_:1},8,["show-empty-vitals","time-frame","is-utc"])]),_:1},8,["tabs"])])])):(c(),v(ht,{key:2}))])):b("",!0)}$=y(J,[["render",nt],["__scopeId","data-v-c6679b92"]])});export{Qt as __tla,$ as default};
