/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{ac as ge,ad as ye,m as _e,n as we,g as A,_ as b,r as s,o as l,c as h,b as o,w as n,a as d,t as E,i as fe,d as c,p as T,e as C,l as u,H as be,W as ve,z as I,J as Re,u as $e,P as Ae,a4 as Ee,I as Te,h as g,O as Ce,R as Ie,U as Me,K as xe,L as We,__tla as Se}from"./index.84d84090.3_3_0_0.js";import{E as Ke,__tla as Le}from"./EntityRecordDetails.1dd06b67.3_3_0_0.js";import{E as De,__tla as Pe}from"./EntityMixin.2764673d.3_3_0_0.js";import{S as Ue,C as qe}from"./consumers.07a3440a.3_3_0_0.js";import{R as He,__tla as ze}from"./RbacPermMixin.3a5f32ef.3_3_0_0.js";import{__tla as Be}from"./monaco-editor.90904fcf.3_3_0_0.js";import{__tla as Ve}from"./EntityButton.1838e0e9.3_3_0_0.js";import{__tla as Ye}from"./EntityFilter.bf4158bc.3_3_0_0.js";let M,Ne=Promise.all([(()=>{try{return Se}catch{}})(),(()=>{try{return Le}catch{}})(),(()=>{try{return Pe}catch{}})(),(()=>{try{return ze}catch{}})(),(()=>{try{return Be}catch{}})(),(()=>{try{return Ve}catch{}})(),(()=>{try{return Ye}catch{}})()]).then(async()=>{const x={props:{adminId:{type:String,required:!0},workspace:{type:String,required:!0}},data(){return{token:"",register_url:""}},computed:{expiry(){const e=ge(this.token).exp;return ye.unix(e).format("MM/DD/YYYY hh:mm:ssa")}},methods:{..._e(we,["notify"]),generateToken(){this.$api.query(`${this.workspace}/admins/${this.adminId}?generate_register_url=true`).then(e=>{this.token=e.data.token,this.register_url=e.data.register_url}).catch(e=>{this.handleError(A(e))})},handleError(e){this.notify({message:e,type:"danger"})},copyUrl(e){e(this.register_url)?(this.notify({message:`Registration link copied. Expires ${this.expiry}`,type:"success"}),window.getSelection().removeAllRanges()):this.handleError("Failed to copy registration link to clipboard")}}},W=e=>(T("data-v-9d24e8e5"),e=e(),C(),e),S={key:0},K=c(" Generate registration link "),L={key:1,class:"copy-token-wrapper"},D=["value"],P=W(()=>d("br",null,null,-1));function U(e,a,t,v,r,i){const p=s("KButton"),k=s("KIcon"),y=s("KTooltip"),_=s("KClipboardProvider");return r.token?(l(),h("div",L,[o(_,null,{default:n(({copyToClipboard:f})=>[d("div",null,[d("input",{id:"invite-token",value:r.register_url,type:"text",readonly:""},null,8,D),P,d("code",null,"Expires: "+E(i.expiry),1),o(y,{label:"Copy registration link",class:"copy-token-tooltip"},{default:n(()=>[o(p,{class:"ml-1",appearance:"outline",size:"small",onClick:fe(R=>i.copyUrl(f),["stop","prevent"])},{icon:n(()=>[o(k,{icon:"copy"})]),_:2},1032,["onClick"])]),_:2},1024)])]),_:1})])):(l(),h("div",S,[o(p,{appearance:"outline","data-testid":"invite-token-button",onClick:i.generateToken},{default:n(()=>[K]),_:1},8,["onClick"])]))}const q=b(x,[["render",U],["__scopeId","data-v-9d24e8e5"]]),H={name:"EmptyStateRoles",props:{id:{type:String,required:!0}}},z=c(" No Roles "),B=c(" Add a role "),V=c(", or manage roles through "),Y=c(" service directory group mappings "),N=c(". "),j=d("br",null,null,-1),F=d("br",null,null,-1),O=c(" Note: Roles added here will be in addition to roles assigned via service directory group mappings. ");function G(e,a,t,v,r,i){const p=s("router-link"),k=s("KEmptyState");return l(),u(k,{"cta-is-hidden":"","cta-text":"Add a Role"},{title:n(()=>[z]),message:n(()=>[o(p,{to:{name:"update-user",params:{id:t.id}}},{default:n(()=>[B]),_:1},8,["to"]),V,o(p,{to:{path:"/teams",hash:"#groups"}},{default:n(()=>[Y]),_:1}),N,j,F,O]),_:1})}const J=b(H,[["render",G]]),Q={name:"AdminsShow",components:{PageHeader:be,EntityRecordDetails:Ke,WorkspaceTitle:ve,RegisterToken:q,EmptyStateRoles:J},mixins:[De,He],data(){return{resource:"admins",record:null,adminWorkspaces:[],roles:{},errorMessage:null,copiedUrl:null,expiry:null,breadcrumbItems:[{key:"teams-overview",to:{path:"/teams",hash:"#admins"},title:"Team Admins",text:"Teams"}]}},computed:{...I(Re,["workspaces","getWorkspaceMeta"]),...I($e,{perms:"permissions"}),authType(){return this.$config.ADMIN_AUTH},rbacResourceEndpoint(){return this.resource},hasRolesReadPerm(){return this.$rbac.isAllowed(this.perms,[{path:"/rbac/roles",actions:["read"]}],this.entityWorkspace||this.workspace)},id(){return this.$route.params.id},workspace(){return this.$route.params.workspace},isLoading(){return!this.record},title(){return this.isLoading?"Loading...":this.record.username},isInvited(){return!this.isLoading&&this.record.status===Ue.INVITED},isBasicAuth(){return this.authType===Ae.BASIC_AUTH},allowedWorkspacesRoles(){return this.adminWorkspaces.reduce((e,a)=>(this.$rbac.isAllowed(this.perms,[{path:"/rbac/roles",actions:["read"]}],a.name)&&e.push(a.name),e),[])},canUpdateAdmins(){return this.$rbac.isAllowed(this.perms,[{path:`/admins/${this.id}`,actions:["update"]}],this.workspace)}},mounted(){this.fetchRecord().then(this.hasRolesReadPerm&&this.fetchAdminRoles).catch(()=>this.$router.push({name:"not-found-workspace",replace:!0}))},methods:{async fetchRecord(){const e=await this.$api.query(`${this.workspace}/admins/${this.id}/workspaces`).then(t=>t.data),a=e.some(t=>t.name==="*");return this.adminWorkspaces=a?this.workspaces:e.filter(t=>t.name!=="*"),this.$api.query(`${this.workspace}/${this.resource}/${this.id}`).then(t=>{this.record=t.data}).catch(Ee(this.$router,404,"/404",{replace:!0}))},async fetchAdminRoles(){const e=await Promise.all(this.adminWorkspaces.map(async a=>await this.$api.query(`${a.name}/admins/${this.id}/roles`).then(t=>({data:t.data.roles.sort(Te("name")),workspace:a.name})).catch(t=>{this.errorMessage=A(t)})));this.roles=e.filter(a=>a.data.length>0).map(a=>({workspace:a.workspace,tableData:{data:a.data,headers:[{label:"Role",key:"name"},{label:"Comment",key:"comment"}]}})).sort((a,t)=>a.workspace.localeCompare(t.workspace))},transformRecord(e){return Object.keys(e).forEach(a=>{if(this.isInvited&&(this.isBasicAuth||!this.authType)&&(e.register_url=""),a==="type"){const t=e[a];e[a]=qe[t]}a==="rbac_user"&&delete e[a],a==="status"&&delete e[a]}),e},rowClickHandler(e,a,t){this.$router.push({name:"teams-view-role",params:{workspace:t.workspace,id:a.id}})}}},X=e=>(T("data-v-4340c836"),e=e(),C(),e),Z={class:"container admin-view"},ee=c(" Edit Admin "),ae={class:"my-4"},te=X(()=>d("svg",{class:"mr-4",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"14"},[d("path",{fill:"#AF9E7D","fill-rule":"evenodd",d:"M14 14H2c-1.105 0-2-.896-2-2V2C0 .895.895 0 2 0h12c1.105 0 2 .895 2 2v10c0 1.104-.895 2-2 2zm0-9.5L9.7377672 8.3360095C9.3303096 8.7027213 8.5561352 9 8 9c-.5522847 0-1.328064-.2952576-1.7377672-.6639905L2 4.5V12h12V4.5zM2.5 2l5.1305892 4.664172c.20402.1854727.5280836.19158.7388216 0L13.5 2h-11z",opacity:".5"})],-1)),re=c(" This user is invited, but has not set up an account. "),se={"data-testid":"admin-roles",class:"admin-roles"},ie={key:0},oe={class:"mb-4"},ne={key:0};function le(e,a,t,v,r,i){const p=s("KBreadcrumbs"),k=s("KButton"),y=s("PageHeader"),_=s("KAlert"),f=s("RegisterToken"),R=s("EntityRecordDetails"),de=s("WorkspaceTitle"),$=s("EmptyStateRoles"),ce=s("KTable"),pe=s("RbacEmptyList"),me=s("RbacValidate");return l(),h("article",Z,[o(p,{items:r.breadcrumbItems},null,8,["items"]),o(y,{title:i.title},{default:n(()=>[!i.isLoading&&i.canUpdateAdmins?(l(),u(k,{key:0,to:{name:"update-user",params:{id:i.id}},appearance:"outline"},{default:n(()=>[ee]),_:1},8,["to"])):g("",!0)]),_:1},8,["title"]),d("div",ae,[i.isInvited?(l(),u(_,{key:0,appearance:"warning","has-left-border":""},{alertMessage:n(()=>[te,re]),_:1})):g("",!0)]),o(R,{record:r.record,"transform-record":i.transformRecord},Ce({_:2},[r.record?{name:"workspaces",fn:n(()=>[c(E(r.record.workspaces.map(m=>m.name).join(", ")),1)])}:void 0,r.record?{name:"register_url",fn:n(()=>[r.adminWorkspaces.filter(m=>m.name!=="*").length?(l(),u(f,{key:0,"admin-id":r.record.id,workspace:r.adminWorkspaces.filter(m=>m.name!=="*")[0].name},null,8,["admin-id","workspace"])):g("",!0)])}:void 0]),1032,["record","transform-record"]),d("section",se,[o(y,{size:5,title:"Roles"}),o(me,{workspace:i.workspace,restricted:[{path:"/rbac/roles",actions:["read"]}]},{default:n(({isAllowed:m})=>[m?(l(),h("div",ie,[(l(!0),h(Ie,null,Me(r.roles,(w,he)=>(l(),h("div",{key:he,"data-testid":"workspace-roles",class:"mb-4 workspace-roles"},[d("div",oe,[o(de,xe(We(e.getWorkspaceMeta(w.workspace))),null,16)]),o(ce,{headers:w.tableData.headers,fetcher:()=>({data:w.tableData.data}),"disable-pagination":!0,"is-loading":i.isLoading,"has-error":r.errorMessage&&r.errorMessage.length,"error-state-title":r.errorMessage,"onRow:click":(ue,ke)=>i.rowClickHandler(ue,ke,w)},{"empty-state":n(()=>[o($,{id:i.id},null,8,["id"])]),_:2},1032,["headers","fetcher","is-loading","has-error","error-state-title","onRow:click"])]))),128)),r.roles.length===0?(l(),u($,{key:0,id:i.id},null,8,["id"])):g("",!0)])):(l(),u(pe,{key:1}))]),_:1},8,["workspace"]),r.errorMessage?(l(),h("div",ne,[o(_,{"alert-message":r.errorMessage,appearance:"danger"},null,8,["alert-message"])])):g("",!0)])])}M=b(Q,[["render",le],["__scopeId","data-v-4340c836"]])});export{Ne as __tla,M as default};
