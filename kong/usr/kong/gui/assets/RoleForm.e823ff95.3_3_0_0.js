/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{_ as w,H as M,m as I,n as U,g as J,I as j,r as p,c as y,b as _,w as f,o as u,a as h,l as g,h as H,d as B,p as K,e as X,__tla as q}from"./index.84d84090.3_3_0_0.js";import{E as z,__tla as W}from"./EntityForm.c5492e4f.3_3_0_0.js";import{B as G,__tla as Q}from"./Breadcrumbs.6127883e.3_3_0_0.js";import{M as V,__tla as Y}from"./MultiChecklist.d117c9be.3_3_0_0.js";import{P as Z,__tla as ee}from"./Pagination.d4ba9ccc.3_3_0_0.js";import{S as te}from"./PortalRole.fccc331b.3_3_0_0.js";import{F as re,__tla as se}from"./FormPage.4b74a91a.3_3_0_0.js";import{E as oe,__tla as le}from"./EntityMixin.2764673d.3_3_0_0.js";import{y as c}from"./js-yaml.c564789b.3_3_0_0.js";import{_ as ae}from"./icon-empty-table.220603e0.3_3_0_0.js";import{__tla as ie}from"./monaco-editor.90904fcf.3_3_0_0.js";import{__tla as ne}from"./ConfirmModalDialog.af276128.3_3_0_0.js";import{__tla as de}from"./EntityDeleteModal.673d985c.3_3_0_0.js";import"./RedirectMixin.efeb36f2.3_3_0_0.js";import{__tla as he}from"./EntityButton.1838e0e9.3_3_0_0.js";import{__tla as ce}from"./EntityFilter.bf4158bc.3_3_0_0.js";let D,pe=Promise.all([(()=>{try{return q}catch{}})(),(()=>{try{return W}catch{}})(),(()=>{try{return Q}catch{}})(),(()=>{try{return Y}catch{}})(),(()=>{try{return ee}catch{}})(),(()=>{try{return se}catch{}})(),(()=>{try{return le}catch{}})(),(()=>{try{return ie}catch{}})(),(()=>{try{return ne}catch{}})(),(()=>{try{return de}catch{}})(),(()=>{try{return he}catch{}})(),(()=>{try{return ce}catch{}})()]).then(async()=>{const b={name:"RoleForm",components:{EntityForm:z,Breadcrumbs:G,PageHeader:M,MultiChecklist:V,Pagination:Z},mixins:[re,oe],data(){return{resourceEndpoint:"developers/roles",schema:{...te},deleteRoleText:"Deleting this role will remove the role from all content files & developers that have this role. This action cannot be undone. Are you sure you want to proceed?",isLoading:null,changed:!1,roleName:null,next:null,devUrl:null,developerMap:{},developerOptions:[],selectedDevelopers:[],developers:[],previous:[],addedDevelopers:new Set,removedDevelopers:new Set}},computed:{id(){return this.$route.params.id},redirectRoute(){return{name:"portal-permissions-list"}},allSelected(){return this.selectedDevelopers.length===0?!1:this.developers.length===this.selectedDevelopers.length}},mounted(){this.devUrl=`${this.workspace}/developers?size=25`,this.isLoading=!0,this.fetchPermissionIfEditing().then(this.fetchDevelopers).then(()=>{this.isLoading=!1}).catch(e=>{this.isLoading=!1,this.handleError(e)})},methods:{...I(U,["notify"]),resetData(){this.developers=[],this.developerMap={},this.developerOptions=[],this.selectedDevelopers=[],this.removedDevelopers.clear(),this.addedDevelopers.clear()},isContentFile(e){return/^content\//.test(e)},isSpecFile(e){return/^specs\//.test(e)},goToPreviousPage(){return this.isLoading=!0,this.devUrl=this.previous.pop(),this.next=null,this.fetchDevelopers().then(()=>{this.isLoading=!1}).catch(e=>{this.isLoading=!1,this.handleError(e)})},goToNextPage(){return this.isLoading=!0,this.previous.push(this.devUrl),this.devUrl=this.next,this.next=null,this.fetchDevelopers().then(()=>{this.isLoading=!1}).catch(e=>{this.isLoading=!1,this.handleError(e)})},selectAll(e){this.changed=!0,e?(this.removedDevelopers.clear(),this.developerOptions.filter(t=>!this.selectedDevelopers.includes(t.name)).forEach(t=>{this.addedDevelopers.add(t.name)}),this.selectedDevelopers=this.developers.map(t=>t.email)):(this.addedDevelopers.clear(),this.developerOptions.filter(t=>this.selectedDevelopers.includes(t.name)).forEach(t=>{this.removedDevelopers.add(t.name)}),this.selectedDevelopers=[])},handleError(e){return this.notify({message:J(e),type:"danger"})},updateRecord(e){return this.$api.updateRecord(this.resourceEndpoint,this.id,e)},fetchPermissionIfEditing(){return this.isEditing?this.$api.findRecord(this.resourceEndpoint,this.id).then(e=>{this.roleName=e&&e.data&&e.data.name}):Promise.resolve()},fetchDevelopers(){return this.resetData(),this.$api.query(this.devUrl).then(e=>{const t=e.data||{};this.developers=t.data||[],t.next&&typeof t.next=="string"&&(this.next=t.next.replace(/^\/+/,"")),this.developers.sort(j("email")).forEach(o=>{const l={name:o.email};try{l.comment=JSON.parse(o.meta).full_name}catch{l.comment=""}this.developerOptions.push(l),Array.isArray(o.roles)&&o.roles.includes(this.roleName)&&this.selectedDevelopers.push(o.email),this.developerMap[o.email]=o}),this.isLoading=!1})},fetchFiles(){return this.$api.findAll("files").then(e=>e&&e.data&&e.data.data||[])},handleChangedSelection(e){this.changed=e.changed},patchContents(e,t){return this.$api.updateRecord("files",e.path,{contents:t})},patchDeveloperRoles(e,t){return this.$api.updateRecord("developers",e,{roles:t})},updateDeveloperRoles(e,t){const o=[];return this.addedDevelopers.forEach(l=>{o.push(this.addRoleToDeveloper(e,l))}),this.removedDevelopers.forEach(l=>{o.push(this.removeRoleFromDeveloper(e,l,t))}),Promise.all(o)},addRoleToDeveloper(e,t){const o=this.developerMap[t];return o.roles=o.roles||[],this.patchDeveloperRoles(t,[...o.roles,e])},removeRoleFromDeveloper(e,t,o){const l=this.developerMap[t].roles.filter(r=>r!==e&&r!==o);return this.patchDeveloperRoles(t,l)},removeRoleFromFile(e,t){return Promise.all(e.reduce((o,l)=>{let r;if(this.isContentFile(l.path)){const s=l.contents.split("---"),a=c.load(s[1]),n=a&&a.readable_by;if(n&&Array.isArray(n)){const i=n.filter(d=>d!==t);i.length!==n.length&&(a.readable_by=i,s[1]=c.dump(a),r=s.join("---"))}}else if(this.isSpecFile(l.path)){let s,a;try{s=JSON.parse(l.contents),a=!0}catch{s=c.load(l.contents)}const n=s&&(s["x-headmatter"]||s["X-headmatter"]),i=n&&n.readable_by;if(i&&Array.isArray(i)){const d=i.filter(m=>m!==t);d.length!==i.length&&(n.readable_by=d,r=a?JSON.stringify(s,void 0,2):c.dump(s))}}return r&&o.push(this.patchContents(l,r)),o},[]))},renameRoleInFiles(e,t,o){return Promise.all(e.reduce((l,r)=>{let s;if(this.isContentFile(r.path)){const a=r.contents.split("---"),n=c.load(a[1]),i=n&&n.readable_by;if(i&&Array.isArray(i)){const d=i.indexOf(o);d>-1&&(i[d]=t,a[1]=c.dump(n),s=a.join("---"))}}else if(this.isSpecFile(r.path)){let a,n;try{a=JSON.parse(r.contents),n=!0}catch{a=c.load(r.contents)}const i=a&&(a["x-headmatter"]||a["X-headmatter"]),d=i&&i.readable_by;if(d&&Array.isArray(d)){const m=d.indexOf(o);m>-1&&(i.readable_by[m]=t,s=n?JSON.stringify(a,void 0,2):c.dump(a))}}return s&&l.push(this.patchContents(r,s)),l},[]))},submitRoleForm(e){const t=this.roleName;this.roleName=e.name;const o=this.roleName!==t,l=async()=>{await this.updateDeveloperRoles(this.roleName,t)};return this.onFormSubmit(e,!this.id&&l).then(()=>{if(this.id)return l()}).then(()=>{if(o)return this.fetchFiles().then(r=>this.renameRoleInFiles(r,this.roleName,t))}).then(()=>{this.changed=!1,this.$router.push(this.redirectRoute)}).catch(r=>{const s=r&&r.response&&r.response.data&&r.response.data;return s&&s.code===5&&(r.response.data.message=`Role "${e.name}" already exists`),Promise.reject(r)})},deleteRole(){return this.onDeleteWhenEditing().then(this.fetchFiles).then(e=>this.removeRoleFromFile(e,this.roleName))}}},v=e=>(K("data-v-5f904347"),e=e(),X(),e),x={class:"portal-role-form"},R={class:"form-group"},F=v(()=>h("label",null,"Developers",-1)),E=v(()=>h("div",{class:"mb-4 developers-help"}," Select the Developers assigned this role ",-1)),P=v(()=>h("div",{class:"card-icon mb-4"},[h("img",{src:ae,alt:""})],-1)),S=B(" No Developers "),N={key:2,class:"developers-multi-wrapper"},A={class:"select-all"},C=["checked"],O=v(()=>h("label",{for:"select-all-input"},[h("div",null,"All"),h("small",null,"Select all on this page")],-1));function L(e,t,o,l,r,s){const a=p("Breadcrumbs"),n=p("PageHeader"),i=p("KSkeleton"),d=p("KEmptyState"),m=p("MultiChecklist"),k=p("Pagination"),T=p("EntityForm");return u(),y("section",x,[_(a),_(n),_(T,{"is-editing":e.isEditing,"prevent-submission-before-change":!1,schema:r.schema,"on-load":e.onFormLoad,"on-submit":s.submitRoleForm,"on-delete":s.deleteRole,"button-text":e.buttonText,"resource-endpoint":r.resourceEndpoint,"delete-modal-text":r.deleteRoleText,"redirect-route-after-delete":{name:"portal-permissions-list"},"entity-name":"Dev Portal Role",entity:"developers/roles"},{afterFormContainer:f(()=>[h("div",R,[F,E,r.isLoading?(u(),g(i,{key:0,"delay-milliseconds":0})):r.developerOptions.length===0?(u(),g(d,{key:1,"cta-is-hidden":""},{title:f(()=>[P,S]),_:1})):(u(),y("div",N,[_(m,{options:r.developerOptions,selected:r.selectedDevelopers,added:r.addedDevelopers,deleted:r.removedDevelopers,onChangedSelection:s.handleChangedSelection},{"custom-item":f(()=>[h("li",A,[h("input",{id:"select-all-input",checked:s.allSelected,"data-option":"select-all-input",type:"checkbox",onChange:t[0]||(t[0]=$=>s.selectAll($.target.checked))},null,40,C),O])]),_:1},8,["options","selected","added","deleted","onChangedSelection"]),!!r.next||r.previous.length>0?(u(),g(k,{key:0,"has-previous":r.previous.length>0,"has-next":!!r.next,onPrevious:s.goToPreviousPage,onNext:s.goToNextPage},null,8,["has-previous","has-next","onPrevious","onNext"])):H("",!0)]))])]),_:1},8,["is-editing","schema","on-load","on-submit","on-delete","button-text","resource-endpoint","delete-modal-text"])])}D=w(b,[["render",L],["__scopeId","data-v-5f904347"]])});export{pe as __tla,D as default};
