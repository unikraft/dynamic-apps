/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{T as j,__tla as $e}from"./entities-plugins.es.44654093.3_3_0_0.js";import{B as Ce,__tla as Re}from"./Breadcrumbs.6127883e.3_3_0_0.js";import{ag as z,c as g,a as y,t as k,b as l,o as a,p as O,e as T,aD as H,aw as F,_ as A,C as w,J as Se,r as c,w as s,ay as u,R as S,U as Q,l as f,S as J,d as v,H as De,V as Ie,h as b,a4 as B,Y as U,K as W,E as Y,O as Ee,__tla as xe}from"./index.84d84090.3_3_0_0.js";import{D as Me,T as Le,__tla as Oe}from"./TagsBlock.4b7d5635.3_3_0_0.js";import{D as Te,__tla as Ae}from"./DetailContainer.85becad9.3_3_0_0.js";import{S as Be,__tla as Ue}from"./StatusBlock.74ff673e.3_3_0_0.js";import{E as Ge,__tla as qe}from"./EntityConfiguration.03651df4.3_3_0_0.js";import{E as Ke,__tla as Ne}from"./EntityDeleteModal.673d985c.3_3_0_0.js";import{E as Ve,__tla as je}from"./EntityMixin.2764673d.3_3_0_0.js";import{p as X,__tla as ze}from"./PluginMeta.6ce8b2b4.3_3_0_0.js";import{c as He,__tla as Fe}from"./CustomSchemas.0e5a07de.3_3_0_0.js";import{R as Qe,__tla as Je}from"./RbacPermMixin.3a5f32ef.3_3_0_0.js";import{c as Z}from"./Plugin.35a28655.3_3_0_0.js";import{R as We}from"./RedirectMixin.efeb36f2.3_3_0_0.js";import{E as ee,__tla as Ye}from"./EntityButton.1838e0e9.3_3_0_0.js";import{u as Xe,__tla as Ze}from"./useDocLink.c461e3a3.3_3_0_0.js";import{__tla as et}from"./monaco-editor.90904fcf.3_3_0_0.js";import{__tla as tt}from"./EntityToggleBadge.6a1cd1fb.3_3_0_0.js";import{__tla as rt}from"./ConfirmModalDialog.af276128.3_3_0_0.js";import"./icon-help.699f8c28.3_3_0_0.js";import{__tla as it}from"./EntityFilter.bf4158bc.3_3_0_0.js";import"./typedefs.6c779761.3_3_0_0.js";import"./index.6d4e40f9.3_3_0_0.js";import"./ArrayCardContainerFields.468b3825.3_3_0_0.js";import"./transform.db23dc95.3_3_0_0.js";import"./marked.esm.77963db0.3_3_0_0.js";let te,at=Promise.all([(()=>{try{return $e}catch{}})(),(()=>{try{return Re}catch{}})(),(()=>{try{return xe}catch{}})(),(()=>{try{return Oe}catch{}})(),(()=>{try{return Ae}catch{}})(),(()=>{try{return Ue}catch{}})(),(()=>{try{return qe}catch{}})(),(()=>{try{return Ne}catch{}})(),(()=>{try{return je}catch{}})(),(()=>{try{return ze}catch{}})(),(()=>{try{return Fe}catch{}})(),(()=>{try{return Je}catch{}})(),(()=>{try{return Ye}catch{}})(),(()=>{try{return Ze}catch{}})(),(()=>{try{return et}catch{}})(),(()=>{try{return tt}catch{}})(),(()=>{try{return rt}catch{}})(),(()=>{try{return it}catch{}})()]).then(async()=>{const G="/__km_base__/assets/icon-descendent.07004225.3_3_0_0.svg?external",re=e=>(O("data-v-44a54165"),e=e(),T(),e),ie={class:"plugin-ordering-empty"},ae={class:"plugin-ordering-empty-title"},ne=re(()=>y("p",{class:"plugin-ordering-empty-desc"}," Add ordering to override the static priority for Plugin execution ",-1)),se=z({__name:"PluginOrderingEmpty",props:{id:null,title:null,workspace:null,entity:null},setup(e){const i=H(),d=F(),m=()=>{d.push({name:"update-plugin-ordering",params:{...i.params}})};return(t,n)=>(a(),g("section",ie,[y("h3",ae,k(e.title),1),ne,l(ee,{workspace:e.workspace,entity:e.entity,"restricted-actions":["update"],"button-props":{appearance:"primary",class:"plugin-ordering-empty-button"},text:"+ Add ordering",onClick:m},null,8,["workspace","entity"])]))}}),q=A(se,[["__scopeId","data-v-44a54165"]]),oe=e=>(O("data-v-eb44f4f9"),e=e(),T(),e),le={class:"ml-6"},de={key:0},ce={class:"plugin-ordering-token"},ue=oe(()=>y("div",{class:"plugin-ordering-phase"},[y("img",{class:"plugin-ordering-descendent",src:G,alt:""}),v(" Access ")],-1)),pe={key:0,class:"plugin-ordering-descendent",src:G,alt:""},me={i18nOptions:{namespaces:["Plugin"],keyPrefix:"ordering"}},he=z({...me,__name:"PluginOrdering",props:{id:null,ordering:null,serviceId:null,routeId:null,consumerId:null},setup(e){const i=e,d=w(()=>{const{serviceId:o,routeId:h,consumerId:p}=i;return p?`consumers/${p}/plugins/${i.id}`:o?`services/${o}/plugins/${i.id}`:h?`routes/${h}/plugins/${i.id}`:`plugins/${i.id}`}),{dynamicOrderingDocLink:m,defaultOrderingDocLink:t}=Xe(),n=Se(),P=w(()=>n.workspace),$=w(()=>{var o,h,p;return!!((p=(h=(o=i.ordering)==null?void 0:o.before)==null?void 0:h.access)!=null&&p.length)}),D=w(()=>{var o,h,p;return!!((p=(h=(o=i.ordering)==null?void 0:o.after)==null?void 0:h.access)!=null&&p.length)}),x=w(()=>$.value||D.value),M=w(()=>[{key:"before",label:"Before",visible:$.value},{key:"after",label:"After",visible:D.value}]),L=H(),C=F(),I=()=>{C.push({name:"update-plugin-ordering",params:{...L.params}})};return(o,h)=>{const p=c("KExternalLink"),E=c("i18next");return a(),g(S,null,[l(u(De),{size:4,title:o.$t("title")},{"below-title":s(()=>[l(u(J),null,{default:s(()=>[y("span",null,[l(E,{translation:o.$t("dynamicDoc")},{docLink:s(()=>[l(p,{href:u(m)},{default:s(()=>[v(k(o.$t("Global:viewDoc")),1)]),_:1},8,["href"])]),_:1},8,["translation"])]),y("span",le,[l(E,{translation:o.$t("defaultDoc")},{docLink:s(()=>[l(p,{href:u(t)},{default:s(()=>[v(k(o.$t("Global:viewDoc")),1)]),_:1},8,["href"])]),_:1},8,["translation"])])]),_:1})]),default:s(()=>[l(u(ee),{workspace:u(P),entity:u(d),"restricted-actions":["update"],"button-props":{appearance:"outline"},text:o.$t("Global:edit"),onClick:I},null,8,["workspace","entity","text"])]),_:1},8,["title"]),u(x)?(a(),g("div",de,[(a(!0),g(S,null,Q(u(M),r=>(a(),g(S,{key:r.key},[y("div",ce,k(r.label),1),r.visible?(a(),g(S,{key:0},[ue,(a(!0),g(S,null,Q(e.ordering[r.key].access,(_,R)=>(a(),g("div",{key:_,class:Ie(["plugin-ordering-name",{"is-first":R===0}])},[R===0?(a(),g("img",pe)):b("",!0),l(u(j),{name:_,class:"plugin-ordering-icon"},null,8,["name"]),v(" "+k(_),1)],2))),128))],64)):(a(),f(q,{key:1,id:e.id,title:"No dynamic ordering applied",workspace:u(P),entity:u(d)},null,8,["id","workspace","entity"]))],64))),128))])):(a(),f(q,{key:1,id:e.id,title:"No dynamic ordering applied",workspace:u(P),entity:u(d)},null,8,["id","workspace","entity"]))],64)}}}),ge=A(he,[["__scopeId","data-v-eb44f4f9"]]),fe={name:"KMPlugin",components:{Breadcrumbs:Ce,SupportText:J,DetailsHeader:Me,DetailContainer:Te,StatusBlock:Be,TagsBlock:Le,EntityConfiguration:Ge,EntityDeleteModal:Ke,PluginIcon:j,PluginOrdering:ge},mixins:[Ve,Qe,We],props:{entity:{type:Object,default:()=>({id:void 0,name:"Plugin",path:"plugin",rootPath:"plugins",createRouteName:null})},updatePathName:{type:String,default:"update-plugin"},returnLinkPath:{type:String,default:""},disableUpdateEntities:{type:Array,default:()=>[]},isAppRegistrationPlugin:{type:Boolean,default:!1},consumerId:{type:String,required:!1,default:""},serviceId:{type:String,required:!1,default:""},routeId:{type:String,required:!1,default:""}},data(){const{plugin:e}=this.$route.params;return{record:null,deleteModalModel:null,redirectRouteAfterDelete:{name:"plugins"},configSchema:null,pluginConfigSchema:null,skeletonProps:{"table-rows":2,"table-columns":2,type:"table"},defaultFormSchema:{enabled:{type:"switch",model:"enabled",label:"Enabled",textOn:"This plugin is Enabled",textOff:"This plugin is Disabled",inputType:"hidden",styleClasses:"field-switch top-border bottom-border hide-label",default:!0},name:{default:e,type:"input",inputType:"hidden",styleClasses:"d-none"},selectionGroup:{type:this.hideForeign?"foreign":"selectionGroup",inputType:"hidden",styleClasses:"bottom-border",fields:[{label:"Global",description:"All Gateway Services, Routes, and Consumers"}]}}}},computed:{navItems(){var e,i,d,m;return[{key:"view-plugin",label:"Configuration"},{key:"plugin-ordering",label:"Ordering",disabled:!!((i=(e=this.record)==null?void 0:e.consumer)!=null&&i.id),tooltip:(m=(d=this.record)==null?void 0:d.consumer)!=null&&m.id?"Consumer-scoped plugins don\u2019t support dynamic ordering":""}]},resourceEndpoint(){return this.entity.rootPath},plugin(){const e=this.$route.params.plugin;return X[e]?X[e].name:e},id(){return this.$route.params.plugin_id||this.$route.params.id},generalConfig(){if(!this.record)return{};const{config:e,...i}=this.record;return i},pluginConfig(){return this.record?this.record.config:{}},isLoading(){return!this.record},title(){return this.isLoading?"Loading...":this.record.username},titleMapping(){return{id:this.$route.params.plugin}},actions(){return[{name:"Edit configuration",testAction:"action-edit",isAllowed:this.hasUpdatePerm,handler:this.handleEdit},{name:"Delete",divider:this.hasUpdatePerm,testAction:"action-delete",isAllowed:this.hasDeletePerm,dangerous:!0,handler:this.confirmDelete}]},editRoute(){return{name:"update-plugin",params:{plugin:this.$route.params.plugin,id:this.id,returnLink:this.returnLinkPath?this.returnLinkPath+this.id:this.$route.fullPath}}},model(){return this.consumerId?`consumers/${this.consumerId}/plugins`:this.serviceId?`services/${this.serviceId}/plugins`:this.routeId?`routes/${this.routeId}/plugins`:"plugins"}},beforeMount(){this.getPluginSchema().then(e=>{const i=He[this.$route.params.plugin],d=this.parseSchema({...Z,...Object.assign({},...e.fields)});this.configSchema={...Z,...d.schema.fields.reduce((m,{model:t,...n})=>({...m,[t]:n}),{}),...i},this.pluginConfigSchema=Object.entries(this.configSchema).reduce((m,[t,n])=>(t.startsWith("config-")&&(m[t.substring(7)]=n),m),{})}).catch(e=>{this.error=e})},mounted(){this.fetchRecord().then(e=>(this.fetchParentRecords(),e)).catch(B(this.$router,404,"/404",{replace:!0}))},methods:{fetchRecord(){return this.$api.findRecord(this.model,this.id).then(e=>{this.record=e.data}).catch(B(this.$router,404,"/404",{replace:!0}))},copyTransformer(){return this.record},async fetchParentRecords(){this.record.service&&this.record.service.id&&this.$api.findRecord("services",this.record.service.id).then(({data:e})=>{this.record.service={id:this.record.service.id,name:U(e,"services")}}).catch(()=>{}),this.record.route&&this.record.route.id&&this.$api.findRecord("routes",this.record.route.id).then(({data:e})=>{this.record.route={id:this.record.route.id,name:U(e,"routes")}}).catch(()=>{}),this.record.consumer&&this.record.consumer.id&&this.$api.findRecord("consumers",this.record.consumer.id).then(({data:e})=>{this.record.consumer={id:this.record.consumer.id,name:U(e,"consumers")}}).catch(()=>{})},handleEdit(){this.$router.push({name:this.editRoute.name,params:this.editRoute.params||{id:this.record.id,returnLink:this.$route.fullPath},query:{...this.editRoute.query,...this.createRedirectRouteQuery(),...this.createPostDeleteRouteQuery()}})},confirmDelete(){this.deleteModalModel={record:this.record}},getPluginSchema(){return this.$api.findRecord("schemas/plugins",this.$route.params.plugin).then(e=>e.data).catch(B(this.$router,404,"/404",{replace:!0}))},transformConfigLabel(e){return e.replace(/^config\./gi,"")}}},_e=e=>(O("data-v-7429eada"),e=e(),T(),e),ye={class:"plugins-view"},ke={class:"plugins-details"},ve={key:0,class:"flex flex-col gap-2 mt-4"},be={class:"flex items-center gap-8"},we=_e(()=>y("p",null,"Configuration details specific to this plugin.",-1));function Pe(e,i,d,m,t,n){const P=c("Breadcrumbs"),$=c("KSkeleton"),D=c("PluginIcon"),x=c("StatusBlock"),M=c("TagsBlock"),L=c("DetailsHeader"),C=c("router-link"),I=c("EntityConfiguration"),o=c("SupportText"),h=c("PluginOrdering"),p=c("DetailContainer"),E=c("EntityDeleteModal");return a(),g("article",ye,[y("section",ke,[l(P,{"title-mapping":n.titleMapping},null,8,["title-mapping"]),t.record?(a(),f(L,{key:1,record:t.record,entity:{...d.entity,id:n.id},actions:n.actions,"hide-title":""},Ee({"title-logo":s(()=>[l(D,{name:e.$route.params.plugin,class:"plugin-icon"},null,8,["name"]),v(" "+k(n.plugin),1)]),_:2},[t.record?{name:"below-title",fn:s(()=>[t.record?(a(),g("div",ve,[y("div",be,["enabled"in t.record?(a(),f(x,{key:0,entity:d.entity.rootPath,record:t.record,"entity-name":"plugin",onUpdateRecord:i[0]||(i[0]=(r,_)=>t.record[r]=_)},null,8,["entity","record"])):b("",!0),t.record.tags&&t.record.tags.length?(a(),f(M,{key:1,tags:t.record.tags},null,8,["tags"])):b("",!0)])])):b("",!0)])}:void 0]),1032,["record","entity","actions"])):(a(),f($,W(Y({key:0},t.skeletonProps)),null,16)),t.record?(a(),f(p,{key:3,entity:d.entity,items:n.navItems,"entity-name":"plugin"},{"view-plugin":s(()=>[l(I,{"config-schema":t.configSchema,"edit-route":n.editRoute,"header-size":5,record:n.generalConfig,"flatten-actions":"",class:"plugin-general-config","header-title":"General configuration",entity:"plugins","entity-name":"plugin","copy-transformer":n.copyTransformer,onUpdateRecord:i[1]||(i[1]=(r,_)=>t.record[r]=_)},{service:s(({value:r})=>[r?(a(),f(C,{key:0,to:{name:"show-service",params:{id:r.id,workspace:e.workspace}},"data-testid":"goto-service"},{default:s(()=>[v(k(r.name||r.id),1)]),_:2},1032,["to"])):b("",!0)]),route:s(({value:r})=>[r?(a(),f(C,{key:0,to:{name:"show-route",params:{id:r.id,workspace:e.workspace}},"data-testid":"goto-route"},{default:s(()=>[v(k(r.name||r.id),1)]),_:2},1032,["to"])):b("",!0)]),consumer:s(({value:r})=>[r?(a(),f(C,{key:0,to:{name:"show-consumer",params:{id:r.id,workspace:e.workspace}},"data-testid":"goto-consumer"},{default:s(()=>[v(k(r.name||r.id),1)]),_:2},1032,["to"])):b("",!0)]),_:1},8,["config-schema","edit-route","record","copy-transformer"]),l(I,{"config-schema":t.pluginConfigSchema,"header-size":5,record:n.pluginConfig,"raw-value":!0,"transform-label":n.transformConfigLabel,class:"plugin-specific-config","header-title":"Plugin specific configuration","hide-actions":"",entity:""},{"below-title":s(()=>[l(o,null,{default:s(()=>[we]),_:1})]),_:1},8,["config-schema","record","transform-label"])]),"plugin-ordering":s(()=>{var r,_,R,K,N,V;return[l(h,{id:n.id,ordering:n.generalConfig.ordering,"service-id":(_=(r=t.record)==null?void 0:r.service)==null?void 0:_.id,"route-id":(K=(R=t.record)==null?void 0:R.route)==null?void 0:K.id,"consumer-id":(V=(N=t.record)==null?void 0:N.consumer)==null?void 0:V.id},null,8,["id","ordering","service-id","route-id","consumer-id"])]}),_:1},8,["entity","items"])):(a(),f($,W(Y({key:2},t.skeletonProps)),null,16))]),l(E,{modelValue:t.deleteModalModel,"onUpdate:modelValue":i[2]||(i[2]=r=>t.deleteModalModel=r),entity:d.entity.rootPath,"redirect-route":t.redirectRouteAfterDelete,"entity-name":"plugin",class:"defaultModal"},null,8,["modelValue","entity","redirect-route"])])}te=A(fe,[["render",Pe],["__scopeId","data-v-7429eada"]])});export{at as __tla,te as default};
