/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{z as v,u as De,J as D,_ as L,r as l,o as n,c as y,a as i,b as p,w as d,l as h,h as C,p as T,e as A,G as B,d as u,t as F,V as R,m as Te,n as Ae,g as Be,I as Fe,R as Re,U as Oe,H as $e,S as Me,Z as Ie,Q as Ne,O as Ue,__tla as Ke}from"./index.84d84090.3_3_0_0.js";import{D as Ve,__tla as Je}from"./DisabledView.3ce50815.3_3_0_0.js";import{E as He,__tla as je}from"./EntityMixin.2764673d.3_3_0_0.js";import{E as ze,__tla as Xe}from"./EntityList.9d5d453d.3_3_0_0.js";import{E as O,__tla as qe}from"./EntityButton.1838e0e9.3_3_0_0.js";import{S as Ge}from"./PortalRole.fccc331b.3_3_0_0.js";import{M as Qe,__tla as Ze}from"./MultiChecklist.d117c9be.3_3_0_0.js";import{F as We,__tla as Ye}from"./FormPage.4b74a91a.3_3_0_0.js";import{P as et,__tla as tt}from"./Pagination.d4ba9ccc.3_3_0_0.js";import{y as E}from"./js-yaml.c564789b.3_3_0_0.js";import{_ as st}from"./icon-empty-table.220603e0.3_3_0_0.js";import{T as at,__tla as it}from"./Tabs.fabb4b38.3_3_0_0.js";import{__tla as rt}from"./monaco-editor.90904fcf.3_3_0_0.js";import{__tla as lt}from"./EntityFilter.bf4158bc.3_3_0_0.js";import{__tla as ot}from"./preferences.ea825a88.3_3_0_0.js";import{__tla as nt}from"./EntityListEmptyState.9b958bba.3_3_0_0.js";import{__tla as dt}from"./EntityToggleBadge.6a1cd1fb.3_3_0_0.js";import{__tla as ct}from"./ConfirmModalDialog.af276128.3_3_0_0.js";import{__tla as pt}from"./EntityDeleteModal.673d985c.3_3_0_0.js";import"./RedirectMixin.efeb36f2.3_3_0_0.js";let $,ht=Promise.all([(()=>{try{return Ke}catch{}})(),(()=>{try{return Je}catch{}})(),(()=>{try{return je}catch{}})(),(()=>{try{return Xe}catch{}})(),(()=>{try{return qe}catch{}})(),(()=>{try{return Ze}catch{}})(),(()=>{try{return Ye}catch{}})(),(()=>{try{return tt}catch{}})(),(()=>{try{return it}catch{}})(),(()=>{try{return rt}catch{}})(),(()=>{try{return lt}catch{}})(),(()=>{try{return ot}catch{}})(),(()=>{try{return nt}catch{}})(),(()=>{try{return dt}catch{}})(),(()=>{try{return ct}catch{}})(),(()=>{try{return pt}catch{}})()]).then(async()=>{const M={name:"RolesTab",components:{EntityList:ze,EntityButton:O},mixins:[He],computed:{...v(De,{perms:"permissions"}),...v(D,["workspace"]),entityListOptions(){return{entity:"developers/roles",entityName:"Role",helpMessage:"Add roles to control access to Dev Portal content.",createRoute:`/${this.workspace}/portal/permissions/create`,fields:Object.assign({},Ge)}},isAllowedToView(){return this.$rbac.isAllowed(this.perms,[{path:`/${this.entityListOptions.entity}/*`,actions:["read"]}],this.workspace)}},methods:{rowClickHandler(t,e){this.$router.push({name:"view-portal-role",params:{id:e.id}})}}},I=t=>(T("data-v-b7adcc89"),t=t(),A(),t),N={class:"portal-roles-tab"},U={class:"portal-roles-tab-header"},K=I(()=>i("div",{class:"roles-help"}," Manage developer roles ",-1));function V(t,e,s,r,o,a){const m=l("EntityButton"),g=l("KDropdownItem"),k=l("EntityList");return n(),y("section",N,[i("div",U,[K,i("nav",null,[p(m,{workspace:t.workspace,entity:`${a.entityListOptions.entity}`,"restricted-actions":["create"],"path-name":"portal-create-role",text:"+ Create Role"},null,8,["workspace","entity"])])]),p(k,{"show-update-action":!1,"show-delete-action":!1,options:a.entityListOptions,"enable-entity-actions":"","overflow-actions":"","row-click-handler":a.rowClickHandler},{extraActions:d(({item:f,rbac:w})=>[a.isAllowedToView?(n(),h(g,{key:0,item:{label:"View",to:{name:"view-portal-role",params:{id:f.name||f.id,returnLink:"portal/permissions"}}}},null,8,["item"])):C("",!0),w.isAllowedToUpdate?(n(),h(g,{key:1,item:{label:"Edit",to:{name:"update-portal-role",params:{id:f.name||f.id,returnLink:"portal/permissions"}}}},null,8,["item"])):C("",!0)]),_:1},8,["options","row-click-handler"])])}const J=L(M,[["render",V],["__scopeId","data-v-b7adcc89"]]),H={name:"KCollapse",props:{title:{type:String,default:""},isActive:{type:Boolean,default:!1},isDisabled:{type:Boolean,default:!1}},data(){return{isOpen:this.isActive&&!this.isDisabled}},methods:{toggleAccordion(){this.isOpen=!this.isOpen&&!this.isDisabled}}},j=t=>(T("data-v-50f7faf9"),t=t(),A(),t),z={key:0,xmlns:"http://www.w3.org/2000/svg",width:"10",height:"16"},X=j(()=>i("path",{fill:"#000","fill-opacity":".35","fill-rule":"evenodd",d:"M1.5 0L10 8l-8.5 8L0 14.5 7 8 0 1.5z"},null,-1)),q=[X],G={class:"collapse-body"},Q={class:"collapse-content"};function Z(t,e,s,r,o,a){return n(),y("div",{class:R([{"is-open":o.isOpen},"collapse-container"])},[i("div",{class:R([{isDisabled:"disabled"},"collapse-header"]),onClick:e[0]||(e[0]=(...m)=>a.toggleAccordion&&a.toggleAccordion(...m))},[s.isDisabled?C("",!0):(n(),y("svg",z,q)),B(t.$slots,"title",{},()=>[u(F(s.title),1)],!0)]),i("div",G,[i("div",Q,[B(t.$slots,"body",{},void 0,!0)])])],2)}const W=L(H,[["render",Z],["__scopeId","data-v-50f7faf9"]]),Y={name:"ContentPermissionsTab",components:{MultiChecklist:Qe,KCollapse:W,EntityButton:O,Pagination:et},mixins:[We],data(){return{allRoles:[],files:{},isLoading:null,pending:null,next:null,previous:[],filesUrl:null}},computed:{...v(D,["workspace"]),redirectRoute(){return{name:"portal-permissions-list"}},noFiles(){return Object.keys(this.files).length===0}},beforeMount(){this.filesUrl=`${this.workspace}/files?type=content&size=25`,this.fetchData()},methods:{...Te(Ae,["notify"]),goToPreviousPage(){return this.isLoading=!0,this.filesUrl=this.previous.pop(),this.next=null,this.fetchData()},goToNextPage(){return this.isLoading=!0,this.previous.push(this.filesUrl),this.filesUrl=this.next,this.next=null,this.fetchData()},fetchData(){return this.files={},this.isLoading=!0,this.fetchAndAssignRoles().then(this.fetchFiles).then(this.reduceFiles).then(()=>{this.isLoading=!1}).catch(t=>{this.isLoading=!1,this.handleError(t)})},handleError(t){return this.notify({message:Be(t),type:"danger"})},isContentFile(t){return/^content\//.test(t)},isSpecFile(t){return/^specs\//.test(t)},fetchAndAssignRoles(){return this.$api.findAll("developers/roles").then(t=>{const e=t&&t.data&&t.data.data||[];this.allRoles=e.map(s=>({name:s.name})).sort(Fe("name"))})},fetchFiles(){return this.$api.query(this.filesUrl).then(t=>{const e=t&&t.data;return e.next&&typeof e.next=="string"&&(this.next=e.next.replace(/^\/+/,"")),e.data||[]})},reduceFiles(t){t.forEach(e=>{if(typeof e.contents!="string")return;const s={added:new Set,deleted:new Set,changed:!1};if(this.isContentFile(e.path))s.splitContents=e.contents.split("---"),s.parsed=E.load(s.splitContents[1])||{},s.readableBy=s.parsed&&s.parsed.readable_by;else if(this.isSpecFile(e.path)){try{s.parsed=JSON.parse(e.contents),s.isJSON=!0}catch{s.parsed=E.load(e.contents)}s.parsed=s.parsed||{};const r=s.parsed&&(s.parsed["x-headmatter"]||s.parsed["X-headmatter"]);s.readableBy=r&&r.readable_by}else return;s.readableBy=s.readableBy||[],s.readableBy==="*"?(s.readableBy=[],s.star=!0):(s.readableBy.sort(),s.star=!1),this.files[e.path]=s})},handleChangedSelection(t,e){this.files[e].added=new Set(t.added),this.files[e].deleted=new Set(t.deleted),this.files[e].star=!1,this.files[e].changed=!0},toggleStar(t,e){t?(this.files[e].added.clear(),this.files[e].readableBy.forEach(s=>{this.files[e].deleted.add(s)})):(this.files[e].deleted.clear(),this.files[e].readableBy.forEach(s=>{this.files[e].added.add(s)})),this.files[e].star=t,this.files[e].changed=!0},formatContents(t,e){let s,r;if(e.star)r="*";else{r=e.readableBy,e.added.forEach(a=>{r.indexOf(a)<0&&r.push(a)});const o=Array.from(e.deleted);r=r.filter(a=>o.indexOf(a)<0)}if(delete e.parsed.readable_by,this.isContentFile(t))e.parsed={readable_by:r,...e.parsed},e.splitContents[1]=E.dump(e.parsed),s=e.splitContents.join(`---
`);else if(this.isSpecFile(t)){const o=e.parsed["x-headmatter"]||e.parsed["X-headmatter"];o?o.readable_by=r:e.parsed={"x-headmatter":{readable_by:r},...e.parsed},s=e.isJSON?JSON.stringify(e.parsed,void 0,2):E.dump(e.parsed)}return s},patchContents(t,e){return this.$api.updateRecord("files",t,{contents:e})},updateFiles(){const t=[];for(const e in this.files){const s=this.files[e];if(s.changed){const r=this.formatContents(e,s);r&&t.push(this.patchContents(e,r))}}return Promise.all(t)},cancel(){this.fetchData()},submitPermissionsForm(){this.updateFiles().then(this.fetchData).then(()=>{this.notify({message:"Permissions updated",type:"success"})}).catch(this.handleError)}}},x=t=>(T("data-v-40f37ba2"),t=t(),A(),t),ee={class:"portal-content-tab"},te=x(()=>i("div",{class:"content-help"}," Configure content permissions ",-1)),se=x(()=>i("div",{class:"card-icon mb-4"},[i("img",{src:st,alt:""})],-1)),ae=u(" No Content Files "),ie={key:2,id:"portal-content-list"},re=["data-testid"],le=["id","data-testid"],oe={class:"select-all"},ne=["id","checked","data-option","onChange"],de=["for"],ce=x(()=>i("div",null,"*",-1)),pe=x(()=>i("small",null,"All authenticated developers can access.",-1)),he=[ce,pe],ue={class:"mt-6"},me=u(" Cancel ");function fe(t,e,s,r,o,a){const m=l("KSkeleton"),g=l("KEmptyState"),k=l("MultiChecklist"),f=l("KCollapse"),w=l("Pagination"),P=l("EntityButton"),S=l("KButton");return n(),y("section",ee,[te,o.isLoading?(n(),h(m,{key:0,"delay-milliseconds":0})):a.noFiles?(n(),h(g,{key:1,"cta-is-hidden":""},{title:d(()=>[se,ae]),_:1})):(n(),y("div",ie,[(n(!0),y(Re,null,Oe(o.files,(b,c)=>(n(),h(f,{key:c,title:c},{title:d(()=>[i("div",{"data-testid":`${c}-title`},F(c),9,re)]),body:d(()=>[i("div",{id:c,"data-testid":`${c}-body`,class:"portal-role-list"},[p(k,{prefix:c,options:o.allRoles,selected:b.readableBy,added:b.added,deleted:b.deleted,onChangedSelection:_=>a.handleChangedSelection(_,c)},{"custom-item":d(()=>[i("li",oe,[i("input",{id:c+"-star-role",checked:b.star,"data-option":c+"-star-role",type:"checkbox",onChange:_=>a.toggleStar(_.target.checked,c)},null,40,ne),i("label",{for:c+"-star-role"},he,8,de)])]),_:2},1032,["prefix","options","selected","added","deleted","onChangedSelection"])],8,le)]),_:2},1032,["title"]))),128)),!!o.next||o.previous.length>0?(n(),h(w,{key:0,"has-previous":o.previous.length>0,"has-next":!!o.next,onPrevious:a.goToPreviousPage,onNext:a.goToNextPage},null,8,["has-previous","has-next","onPrevious","onNext"])):C("",!0),i("div",ue,[p(P,{workspace:t.workspace,"restricted-actions":["update"],entity:"files/*","button-props":{appearance:"primary",type:"submit",class:"mr-2"},"is-loading":o.pending,text:"Update",onClick:a.submitPermissionsForm},null,8,["workspace","is-loading","onClick"]),p(S,{appearance:"outline",onClick:a.cancel},{default:d(()=>[me]),_:1},8,["onClick"])])]))])}const _e=L(Y,[["render",fe],["__scopeId","data-v-40f37ba2"]]),ye={name:"PermissionsList",components:{PageHeader:$e,Tabs:at,SupportText:Me,DisabledView:Ve,PortalRolesTab:J,ContentPermissionsTab:_e},data(){return{tabs:[{hash:"#roles",title:"Roles"},{hash:"#content",title:"Content"}]}},computed:{...v(Ie,["info"]),...v(Ne,{portalDocs:"docsPortal"}),...v(D,["workspace","workspaceConfig"]),portalEnabled(){return this.workspaceConfig.portal},portalIsLegacy(){const t=this.info.configuration&&this.info.configuration.portal_is_legacy,e=this.workspaceConfig.portal_is_legacy;return e!==null?e:t}}},ge=i("strong",null,"The Dev Portal is disabled!",-1),be=u(" To enable visit the "),ve=u(" Portal Settings "),ke=u(" page or visit our "),we=["href"],Ce=u(" to learn more. "),xe=u("Set permissions to grant or restrict access to content in this developer portal. "),Pe=["href"],Se={class:"row mt-4"},Le={class:"col"};function Ee(t,e,s,r,o,a){const m=l("router-link"),g=l("DisabledView"),k=l("PageHeader"),f=l("SupportText"),w=l("PortalRolesTab"),P=l("RbacEmptyList"),S=l("RbacValidate"),b=l("ContentPermissionsTab"),c=l("Tabs");return n(),y("section",null,[!a.portalEnabled||a.portalIsLegacy?(n(),h(g,{key:0,class:"mb-7"},Ue({_:2},[a.portalEnabled?a.portalIsLegacy?{name:"disabledMessage",fn:d(()=>[i("strong",null,"The Dev Portal is in Legacy Mode!"),u(" To manage Dev Portal Permissions, disable Legacy Mode in the "),p(m,{to:{name:"portal-settings"}},{default:d(()=>[u(" Portal Settings ")]),_:1}),u(". ")])}:void 0:{name:"disabledMessage",fn:d(()=>[ge,be,p(m,{to:{name:"portal-settings"}},{default:d(()=>[ve]),_:1}),ke,i("a",{href:`${t.portalDocs.url}/enable/`},"documentation",8,we),Ce])}]),1024)):C("",!0),p(k),p(f,null,{default:d(()=>[i("p",null,[xe,i("a",{href:`${t.portalDocs.url}/authentication/developer-permissions/`},"Learn More",8,Pe)])]),_:1}),i("div",Se,[i("div",Le,[p(c,{tabs:o.tabs},{Roles:d(()=>[p(S,{workspace:t.workspace,restricted:[{path:"/developers/roles",actions:["read"]}]},{default:d(({isAllowed:_})=>[_&&a.portalEnabled&&!a.portalIsLegacy?(n(),h(w,{key:0})):(n(),h(P,{key:1}))]),_:1},8,["workspace"])]),Content:d(()=>[p(S,{workspace:t.workspace,restricted:[{path:"/developers/roles",actions:["read"]},{path:"/files",actions:["read"]}]},{default:d(({isAllowed:_})=>[_&&a.portalEnabled&&!a.portalIsLegacy?(n(),h(b,{key:0})):(n(),h(P,{key:1}))]),_:1},8,["workspace"])]),_:1},8,["tabs"])])])])}$=L(ye,[["render",Ee]])});export{ht as __tla,$ as default};
