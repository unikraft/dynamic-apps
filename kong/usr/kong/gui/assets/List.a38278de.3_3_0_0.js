/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{H as U,S as A,M as H,z as y,u as W,I as R,J as C,m as S,n as Me,g as K,_ as T,r,o as l,c as w,a as h,b as i,w as c,l as b,h as v,d as u,t as P,W as xe,K as Ve,L as Ne,N as Ie,O as De,p as Je,e as je,Q as Be,__tla as Fe}from"./index.84d84090.3_3_0_0.js";import{T as Ge,__tla as qe}from"./Tabs.fabb4b38.3_3_0_0.js";import{K as O,__tla as ze}from"./KEntityList.599bcd88.3_3_0_0.js";import{S as $}from"./consumers.07a3440a.3_3_0_0.js";import{E as Qe,__tla as Ye}from"./EntityList.9d5d453d.3_3_0_0.js";import{__tla as Xe}from"./monaco-editor.90904fcf.3_3_0_0.js";import{__tla as Ze}from"./KDataProvider.78c9bca8.3_3_0_0.js";import{__tla as es}from"./preferences.ea825a88.3_3_0_0.js";import{__tla as ss}from"./EntityDeleteModal.673d985c.3_3_0_0.js";import{__tla as ts}from"./ConfirmModalDialog.af276128.3_3_0_0.js";import{__tla as as}from"./EntityMixin.2764673d.3_3_0_0.js";import{__tla as rs}from"./EntityButton.1838e0e9.3_3_0_0.js";import{__tla as os}from"./EntityFilter.bf4158bc.3_3_0_0.js";import"./RedirectMixin.efeb36f2.3_3_0_0.js";import{__tla as ns}from"./EntityListEmptyState.9b958bba.3_3_0_0.js";import{__tla as is}from"./EntityToggleBadge.6a1cd1fb.3_3_0_0.js";let M,cs=Promise.all([(()=>{try{return Fe}catch{}})(),(()=>{try{return qe}catch{}})(),(()=>{try{return ze}catch{}})(),(()=>{try{return Ye}catch{}})(),(()=>{try{return Xe}catch{}})(),(()=>{try{return Ze}catch{}})(),(()=>{try{return es}catch{}})(),(()=>{try{return ss}catch{}})(),(()=>{try{return ts}catch{}})(),(()=>{try{return as}catch{}})(),(()=>{try{return rs}catch{}})(),(()=>{try{return os}catch{}})(),(()=>{try{return ns}catch{}})(),(()=>{try{return is}catch{}})()]).then(async()=>{const x={name:"AdminsTab",components:{PageHeader:U,SupportText:A,KEntityList:O},props:{workspaceReadPermissions:{type:Object,default:()=>{}}},data(){return{currentState:"pending",userToDelete:null,sortKeyAccepted:"username",sortKeyInvited:"email",isEmpty:!1,usersMachine:H({id:"usersMachine",initial:"pending",states:{pending:{on:{RESOLVE:"success",REJECT:"error"}},success:{on:{CLICK_DELETE:"confirm"}},confirm:{on:{RESOLVE:"success",REJECT:"modalError",CANCEL:"success"}},modalError:{on:{RESOLVE:"confirm",CANCEL:"success"}},error:{on:{type:"final"}}}}),tableSettings:{hasHover:!0,options:{headers:[{label:"Email",key:"email",sortable:!0},{label:"Workspace Access",key:"workspaces",sortable:!0,slot:!0},{label:"Invite",key:"created_at",sortable:!0}],data:[]}},acceptedUsers:{headers:[{label:"Username",key:"username",sortable:!0},{label:"Email",key:"email",sortable:!0},{label:"Workspace Access",key:"workspaces",sortable:!0}],data:[]}}},computed:{...y(W,{perms:"permissions"}),...y(C,{workspaces:e=>e.workspaces.sort(R("name"))}),selectedWorkspace(){return this.workspacesWithPermissions[0]&&this.workspacesWithPermissions[0].name},acceptedUsersHasLength(){return this.acceptedUsers.data.length},workspacesWithPermissions(){return this.workspaces.filter(e=>this.workspaceReadPermissions[e.name].admins).sort()},canCreateAdmins(){return this.workspacesWithPermissions.some(e=>this.$rbac.isAllowed(this.perms,[{path:"/admins/",actions:["create"]}],e.name))},canReadAdmins(){return this.workspacesWithPermissions.some(e=>this.$rbac.isAllowed(this.perms,[{path:"/admins/",actions:["read"]}],e.name))}},methods:{...S(Me,["notify"]),...S(C,["setWorkspace"]),transition(e,s){this.currentState=this.usersMachine.transition(this.currentState,e).value;for(const o in s)this.$data[o]=s[o]},filterAcceptAndInvitedAdmins(e){const s=[];this.workspacesWithPermissions.forEach(n=>{e.forEach(a=>{const t=s.find(m=>m.id===a.id),d=a.workspaces.find(m=>m.name===n.name);!t&&d&&(a.workspaceHref=n.name,s.push(a))})});const o=s.map(n=>(n.workspaces=n.workspaces.filter(a=>!a.is_admin_workspace),n)).sort(R("username"));this.acceptedUsers.data=o.filter(n=>n.status===$.APPROVED),this.tableSettings.options.data=o.filter(n=>n.status===$.INVITED),this.isEmpty=!this.tableSettings.options.data.length},rowClickHandler(e,s){this.handleRouteChange("view-user",s.workspaceHref,{id:s.id})},handleRouteChange(e,s,o){this.setWorkspace(s),this.$router.push({name:e,params:{workspace:s,...o}})},handleResolve(e){this.filterAcceptAndInvitedAdmins(e),this.transition(e.length?"RESOLVE":"RESOLVE_EMPTY")},handleError(e){this.transition("REJECT",{errorText:K(e)})},handleSuccess(e){return this.transition("RESOLVE",{userToDelete:null}),this.notify({message:e,type:"success"})}}},V={class:"admins-list"},N={key:0},I={class:"users-list mb-7"},D={class:"d-flex justify-content-between align-items-center mb-4"},J=u(" Users that have access to Kong Manager and the Admin API "),j=u(" + Invite Admin "),B={class:"invited-users-list"},F=h("p",null,"Members without access waiting to accept the invitation.",-1),G=u(" No Invited Users "),q={key:1};function z(e,s,o,n,a,t){const d=r("SupportText"),m=r("KButton"),k=r("KTable"),f=r("PageHeader"),E=r("KEntityList"),_=r("KEmptyState"),g=r("RbacEmptyList");return l(),w("section",V,[t.canReadAdmins?(l(),w("div",N,[h("div",null,[h("section",I,[h("div",D,[i(d,{class:"pb-0"},{default:c(()=>[J]),_:1}),["success","confirm"].includes(a.currentState)&&t.canCreateAdmins?(l(),b(m,{key:0,"data-testid":"invite-admin",appearance:"primary",onClick:s[0]||(s[0]=p=>t.handleRouteChange("invite-user",t.workspacesWithPermissions[0].name))},{default:c(()=>[j]),_:1})):v("",!0)]),i(k,{headers:a.acceptedUsers.headers,fetcher:p=>({data:a.acceptedUsers.data}),"initial-fetcher-params":{sortColumnKey:a.sortKeyAccepted,sortColumnOrder:"asc"},"is-loading":a.currentState==="pending","has-error":a.currentState==="error","disable-pagination":!0,"enable-client-sort":!0,"empty-state-title":"No Users","onRow:click":t.rowClickHandler},{workspaces:c(({row:p})=>[u(P(p.workspaces.map(L=>L.name).join(", ")),1)]),_:1},8,["headers","fetcher","initial-fetcher-params","is-loading","has-error","onRow:click"])]),h("section",B,[i(f,{size:4,title:"Invited"}),F,i(E,{ref:"kEntityList","table-settings":a.tableSettings,"show-update-action":!1,"selected-workspace":t.selectedWorkspace,"row-click-handler":t.rowClickHandler,"resource-url":"admins",params:{all_workspaces:!0},"entity-name":"Admins",onResolve:t.handleResolve,onError:s[1]||(s[1]=p=>t.transition("REJECT"))},{workspaces:c(({row:p})=>[u(P(p.workspaces&&p.workspaces.map(L=>L.name).join(", ")),1)]),_:1},8,["table-settings","selected-workspace","row-click-handler","onResolve"]),a.isEmpty?(l(),b(_,{key:0,"data-testid":"invited-users-empty-state","cta-is-hidden":""},{title:c(()=>[G]),_:1})):v("",!0)])])])):(l(),w("div",q,[i(g)]))])}const Q=T(x,[["render",z]]),Y={name:"WorkspaceList",components:{WorkspaceTitle:xe},props:{metricColumns:{type:Array,default:()=>[]},actionPath:{type:String,default:""},metricCount:{type:Function,default:e=>e},workspaceReadPermissions:{type:Object,default:()=>{}}},computed:{...y(C,["workspaces","getWorkspaceMeta"]),headers(){return[{label:"Workspace",key:"workspace",sortable:!0},...this.metricColumns,{hideLabel:!0,key:"actions"}]},workspacesWithPermissions(){return this.workspaces.filter(e=>this.workspaceReadPermissions[e.name].roles).sort()}},watch:{workspaces:{handler:function(){this.metricCount(this.workspacesWithPermissions).then(e=>{this.sortedData=e.sort(R("workspace"))})},immediate:!0}},methods:{...S(C,["setWorkspace"]),async fetcher(){return await this.metricCount(this.workspacesWithPermissions).then(e=>{this.sortedData=e.sort(R("workspace"))}),this.sortedData?{data:this.sortedData}:{data:[]}},defaultRowClickHandler(e,s){this.setWorkspace(s.workspace),this.$router.push({name:this.actionPath,params:{workspace:s.workspace}})},async fetchMetrics(){const e=this,s=await Promise.all(this.workspaces.map(async function(o){console.log(o);const n=await e.$api.query(`workspaces/${o.name}/meta`).then(t=>console.log(t.data)||t.data.counts),a=e.metricColumns.reduce((t,d)=>(t={...t,[d.key]:n[d.key]||0},t),{});return{workspace:o.name,...a}}));this.sortedData=s.sort(R("workspace"))}}};function X(e,s,o,n,a,t){const d=r("WorkspaceTitle"),m=r("KTable");return l(),b(m,{headers:t.headers,fetcher:t.fetcher,"enable-client-sort":"","disable-pagination":"","onRow:click":t.defaultRowClickHandler},{workspace:c(({row:k})=>[i(d,Ve(Ne(e.getWorkspaceMeta(k.workspace))),null,16)]),_:1},8,["headers","fetcher","onRow:click"])}const Z=T(Y,[["render",X],["__scopeId","data-v-fc9662d8"]]),ee={name:"RolesTab",components:{SupportText:A,WorkspaceList:Z},props:{workspaceReadPermissions:{type:Object,default:()=>{}}},data(){return{metricColumns:[{label:"Roles",key:"rbac_roles",sortable:!0}]}},computed:{canReadRoles(){return Object.keys(this.workspaceReadPermissions).some(e=>this.workspaceReadPermissions[e].roles)}},methods:{async getRoleCount(e){return await Promise.all(e.map(async s=>{const o=await this.$api.query(`${s.name}/rbac/roles`).then(n=>n.data.data.length);return{workspace:s.name,rbac_roles:o}}))}}},se={class:"roles-list"},te={key:0},ae=u("Set of permissions that can be applied to an Admin, RBAC User, or Group");function re(e,s,o,n,a,t){const d=r("SupportText"),m=r("WorkspaceList"),k=r("RbacEmptyList");return l(),w("section",se,[t.canReadRoles?(l(),w("div",te,[i(d,null,{default:c(()=>[ae]),_:1}),i(m,{"metric-columns":a.metricColumns,"metric-count":t.getRoleCount,"workspace-read-permissions":o.workspaceReadPermissions,"action-path":"workspace-roles"},null,8,["metric-columns","metric-count","workspace-read-permissions"])])):(l(),b(k,{key:1}))])}const oe=T(ee,[["render",re]]),ne={name:"RbacUsersTab",components:{KEntityList:O,SupportText:A},mixins:[Ie],props:{workspaceReadPermissions:{type:Object,default:()=>{}}},data(){return{selectedWorkspace:"",workspaceUsers:[],errorMessage:null,sortKey:"Name",machine:H({id:"RbacUsersMachine",initial:"idle",states:{idle:{on:{FETCH:"pending",REJECT:"error"}},pending:{on:{RESOLVE:"success",RESOLVE_EMPTY:"empty",REJECT:"error"}},empty:{on:{FETCH:"pending",REJECT:"error"}},success:{on:{FETCH:"pending",REJECT:"error"}},error:{on:{FETCH:"pending"}}}}),tableSettings:{hasHover:!0,options:{headers:[{label:"Name",key:"name",sortable:!0},{label:"Comment",key:"comment",sortable:!0}],data:[]}}}},computed:{...y(W,{perms:"permissions"}),...y(C,["workspaces"]),allowedWorkspaces(){return this.workspaces.filter(e=>this.workspaceReadPermissions[e.name].rbacUsers).sort(R("name"))},tableData(){return{headers:[{label:"Name",key:"name",sortable:!0},{label:"Comment",key:"comment",sortable:!0}],data:this.workspaceUsers}},workspaceQuery(){return this.$route.query.workspace},canCreateUsers(){return this.$rbac.isAllowed(this.perms,[{path:"/rbac/users/",actions:["create"]}],this.selectedWorkspace)},canReadUsers(){return this.$rbac.isAllowed(this.perms,[{path:"/rbac/users/",actions:["read"]}],this.selectedWorkspace)},entityListOptions(){return{entityName:"Endpoint",entity:"rbac/users",fields:{}}}},beforeMount(){if(this.workspaceQuery||this.allowedWorkspaces.length){const e=this.workspaceQuery||this.allowedWorkspaces[0].name;this.selectedWorkspace=e,this.transition("FETCH")}},methods:{fetchUsersByPage(e,s){return this.transition("FETCH"),this.$api.query(`${e}${s}`).then(o=>{const{data:{data:n}}=o;return this.transition(n.length?"RESOLVE":"RESOLVE_EMPTY"),o.data}).catch(this.handleError)},async fetchUsers(e,s=1e3){this.workspaceUsers=[];let o=`/rbac/users?size=${s}`,n=!1;do await this.fetchUsersByPage(e,o).then(a=>{this.workspaceUsers.push(...a.data),n=!!a.next,o=n&&a.next+`&size=${s}`});while(n)},handleWorkspaceChange(e){this.$router.replace({...this.$router.currentRoute.value,query:{workspace:e}}),this.transition("FETCH")},handleResolve(e){this.transition(e.length?"RESOLVE":"RESOLVE_EMPTY")},handleError(e){this.transition("REJECT",{errorMessage:K(e)})},rowClickHandler(e,s){this.$router.push({name:"show-rbac-user",params:{workspace:this.selectedWorkspace,id:s.id||s.name}})}}},ie=e=>(Je("data-v-3d93fe80"),e=e(),je(),e),ce={class:"rbac-users"},le={key:0},pe={class:"tab-header"},de=u(" Users that have programmatic access to Kong's Admin API "),me={class:"d-flex justify-content-between align-items-end mb-4"},ue={class:"form-group workspace-picker"},he=ie(()=>h("label",null,"Workspace:",-1)),ke=u(" Add New User "),we=u(" No RBAC Users in Workspace "),ye=u(" Add an RBAC User "),be={key:1};function _e(e,s,o,n,a,t){const d=r("SupportText"),m=r("KSelect"),k=r("KButton"),f=r("KEntityList"),E=r("router-link"),_=r("KEmptyState"),g=r("RbacEmptyList");return l(),w("section",ce,[t.canReadUsers?(l(),w("div",le,[h("div",pe,[i(d,{class:"mt-2"},{default:c(()=>[de]),_:1}),h("div",me,[h("div",ue,[he,i(m,{modelValue:a.selectedWorkspace,"onUpdate:modelValue":s[0]||(s[0]=p=>a.selectedWorkspace=p),appearance:"select",items:t.allowedWorkspaces.map(p=>({value:p.name,label:p.name})),onChange:s[1]||(s[1]=p=>t.handleWorkspaceChange(p.value))},null,8,["modelValue","items"])]),h("div",null,[t.canCreateUsers?(l(),b(k,{key:0,to:{name:"create-rbac-user",params:{workspace:a.selectedWorkspace}},appearance:"primary"},{default:c(()=>[ke]),_:1},8,["to"])):v("",!0)])])]),(l(),b(f,{ref:"endpointList",key:a.selectedWorkspace,"selected-workspace":a.selectedWorkspace,"table-settings":a.tableSettings,"entity-name":t.entityListOptions.entityName,"resource-url":t.entityListOptions.entity,"show-update-action":!1,"row-click-handler":t.rowClickHandler,onResolve:t.handleResolve,onError:s[2]||(s[2]=p=>e.transition("REJECT"))},null,8,["selected-workspace","table-settings","entity-name","resource-url","row-click-handler","onResolve"])),e.currentState==="empty"?(l(),b(_,{key:0,"cta-is-hidden":""},De({title:c(()=>[we]),_:2},[t.canCreateUsers?{name:"message",fn:c(()=>[i(E,{to:{name:"create-rbac-user",params:{workspace:a.selectedWorkspace}}},{default:c(()=>[ye]),_:1},8,["to"]),u(" to the "+P(a.selectedWorkspace)+" workspace ",1)])}:void 0]),1024)):v("",!0)])):(l(),w("div",be,[i(g)]))])}const fe=T(ne,[["render",_e],["__scopeId","data-v-3d93fe80"]]),Ee={name:"GroupsTab",components:{EntityList:Qe,SupportText:A},computed:{...y(W,{perms:"permissions"}),entityListOptions(){return{entity:"groups",parentRoute:"teams",entityName:"Group",createRoute:"/teams/groups/create-group",helpMessage:"Add groups to grant Kong role permissions to a service directory group",ctaMessage:"New group",fields:{name:{label:"Name"},comment:{label:"Comment"}}}}},methods:{rowClickHandler(e,s){this.$router.push({name:"update-group",params:{id:s.id}})}}},ge={class:"groups"},Re={key:0,class:"groups"},Ce={class:"d-flex justify-content-between align-items-center mb-4"},Te=u(" Mapping relationships between your service directory group and Kong Manager roles. "),ve=u(" New Group "),Ae={key:1};function We(e,s,o,n,a,t){const d=r("SupportText"),m=r("KButton"),k=r("RbacValidate"),f=r("EntityList"),E=r("RbacEmptyList");return l(),w("section",ge,[i(k,{restricted:[{path:"/groups",actions:["read"]}],workspace:"default"},{default:c(({isAllowed:_})=>[_?(l(),w("div",Re,[h("div",Ce,[i(d,{class:"pb-0"},{default:c(()=>[Te]),_:1}),i(k,{restricted:[{path:"/groups",actions:["create"]}],workspace:"default"},{default:c(({isAllowed:g})=>[g?(l(),b(m,{key:0,to:{name:"create-group"},appearance:"primary"},{default:c(()=>[ve]),_:1})):v("",!0)]),_:1})]),_?(l(),b(f,{key:0,"row-click-handler":t.rowClickHandler,options:t.entityListOptions},null,8,["row-click-handler","options"])):v("",!0)])):(l(),w("div",Ae,[i(E)]))]),_:1})])}const Le=T(Ee,[["render",We]]),Se={name:"TeamsList",components:{PageHeader:U,Tabs:Ge,SupportText:A,AdminsTab:Q,RolesTab:oe,RbacUsersTab:fe,GroupsTab:Le},data(){return{tabs:[{hash:"#admins",title:"Admins"},{hash:"#rbac-users",title:"RBAC Users"},{hash:"#groups",title:"Groups"},{hash:"#roles",title:"Roles"}]}},computed:{...y(W,{perms:"permissions",isSuperAdmin:"isSuperAdmin"}),...y(Be,{docsLink:"docsEnterprise"}),...y(C,["workspaces"]),workspacePermissions(){return this.workspaces.reduce((e,s)=>(e[s.name]={admins:this.$rbac.isAllowed(this.perms,[{path:"/admins/",actions:["read"]}],s.name),rbacUsers:this.$rbac.isAllowed(this.perms,[{path:"/rbac/users/",actions:["read"]}],s.name),roles:this.$rbac.isAllowed(this.perms,[{path:"/rbac/roles/",actions:["read"]}],s.name)},e),{})}}},Pe={class:"container"},Ue=u(" Use this section to define & understand access to Kong across your teams and workspaces. "),He=u(" Learn more "),Ke={class:"row mt-4"},Oe={class:"col"};function $e(e,s,o,n,a,t){const d=r("PageHeader"),m=r("KExternalLink"),k=r("SupportText"),f=r("AdminsTab"),E=r("RbacUsersTab"),_=r("GroupsTab"),g=r("RolesTab"),p=r("Tabs");return l(),w("section",Pe,[i(d),i(k,null,{default:c(()=>[h("p",null,[Ue,i(m,{href:e.docsLink.url+"kong-manager/auth/rbac/add-admin/"},{default:c(()=>[He]),_:1},8,["href"])])]),_:1}),h("div",Ke,[h("div",Oe,[i(p,{tabs:a.tabs},{Admins:c(()=>[i(f,{"workspace-read-permissions":t.workspacePermissions},null,8,["workspace-read-permissions"])]),"RBAC-Users":c(()=>[i(E,{"workspace-read-permissions":t.workspacePermissions},null,8,["workspace-read-permissions"])]),Groups:c(()=>[i(_)]),Roles:c(()=>[i(g,{"workspace-read-permissions":t.workspacePermissions},null,8,["workspace-read-permissions"])]),_:1},8,["tabs"])])])])}M=T(Se,[["render",$e],["__scopeId","data-v-a0e59e09"]])});export{cs as __tla,M as default};
