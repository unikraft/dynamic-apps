/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{N as L,M as w,m as x,n as v,a5 as U,Y as M,a4 as R,g as B,a3 as F,a1 as j,a6 as J,a7 as V,_ as P,r as u,o as m,l as b,c as T,G as C,h as f,b as E,a as q,w as I,d as K,__tla as H}from"./index.84d84090.3_3_0_0.js";import{C as G,__tla as Y}from"./ConfirmModalDialog.af276128.3_3_0_0.js";import{E as z,__tla as Q}from"./EntityDeleteModal.673d985c.3_3_0_0.js";import{E as W,__tla as X}from"./EntityMixin.2764673d.3_3_0_0.js";import{R as Z}from"./RedirectMixin.efeb36f2.3_3_0_0.js";let _,ee=Promise.all([(()=>{try{return H}catch{}})(),(()=>{try{return Y}catch{}})(),(()=>{try{return Q}catch{}})(),(()=>{try{return X}catch{}})()]).then(async()=>{const O={name:"NativeEntityForm",components:{ConfirmModalDialog:G,EntityDeleteModal:z},mixins:[W,L,Z],props:{entity:{type:String,default:""},entityName:{type:String,default:""},redirectRouteAfterDelete:{type:Object,default:null},buttonText:{type:String,default:""},schema:{type:Object,default:()=>({})},fields:{type:Object,default:()=>({})},onLoad:{type:Function,default:()=>new Promise(e=>e(!1))},onSubmit:{type:Function,default:()=>{}},showDelete:{type:Boolean,default:!0},onDelete:{type:Function,default:()=>{}},onFormCancel:{type:Function,default:null},isEditing:{type:Boolean,default:!1},showConfirmationDialog:{type:Boolean,default:!1},preventSubmissionBeforeChange:{type:Boolean,default:!0},preventNotify:{type:Boolean,required:!1,default:!1},schemaEndpoint:{type:String,required:!1,default:""},resourceEndpoint:{type:String,required:!0},deleteModalText:{type:String,default:""},enableSubmit:{type:Boolean,default:!1}},emits:["model-updated"],data(){return{isModalOpen:!1,backendSchema:null,disabled:!1,errorMessage:null,originalModel:{},formModel:{},formSchema:{},formOptions:{helpAsHtml:!0},lang:{MODAL_CONTENT:{text:null,proceedText:null,dismissText:null}},machine:w({id:"entityFormMachine",initial:"idle",states:{idle:{on:{FETCH:"pending",REJECT:"error"}},pending:{on:{RESOLVE:"success",REJECT:"error"}},success:{on:{SUBMIT:"submitting",UPDATE:"confirm_update",DELETE:"confirm_delete"}},confirm_update:{on:{SUBMIT:"submitting",REJECT:"error",CANCEL:"success"}},confirm_delete:{on:{SUBMIT:"deleting",REJECT:"error",CANCEL:"success"}},submitting:{on:{RESOLVE:"idle",REJECT:"error",CANCEL:"success"}},deleting:{on:{RESOLVE:"idle",REJECT:"error",CANCEL:"success"}},error:{on:{RESOLVE:"success"}}}})}},computed:{isUpdating(){return this.buttonText.toLowerCase()==="save"},confirmButtonText(){return{pending:"Loading...",submitting:"Submitting...",deleting:"Deleting..."}[this.currentState]||this.buttonText},id(){return this.$route.params.id||this.formModel.id},isAllowedToUpdate(){return this.$rbac.isAllowed(this.perms,[{path:`/${this.resourceEndpoint}/${this.id||"*"}`,actions:["update"]}],this.workspace)},isAllowedToCreate(){return this.$rbac.isAllowed(this.perms,[{path:`/${this.resourceEndpoint}`,actions:["create"]}],this.workspace)},isAllowedToDelete(){return this.showDelete&&this.isEditing},entityId(){return this.$route&&this.$route.query&&this.$route.query.entity_id},entityType(){return this.$route&&this.$route.query&&this.$route.query.entity_type&&this.$route.query.entity_type.replace("_","-")},_schemaEndpoint(){return this.schemaEndpoint||this.resourceEndpoint},deleteModalModel(){return["confirm_delete","deleting"].includes(this.currentState)?{record:this.originalModel}:null},isSaveActionDisabled(){return this.currentState==="submitting"||this.disabled}},watch:{formModel:{handler:function(){this.checkUpdateable()},deep:!0},backendSchema:{handler:function(){const e=this.parseSchema(Object.assign({},...this.backendSchema),Object.assign({},...this.schema&&this.schema.fields||[])),i=this.isUpdating?this.isAllowedToUpdate:this.isAllowedToCreate;this.formModel=e.model,this.formSchema={fields:e.schema.fields.map(s=>({...s,disabled:!i}))},this.originalModel=JSON.parse(JSON.stringify(e.model))}},enableSubmit:{handler:function(){this.disabled=!this.enableSubmit}}},mounted(){this.load()},methods:{...x(v,["notify"]),load(){this.transition("FETCH"),this.disabled=!0,this.fetchSchema().then(e=>(this.backendSchema=e,this.onLoad())).then(e=>this.handleLoad(e)).catch(this.handleError)},checkUpdateable(){!this.preventSubmissionBeforeChange||(this.disabled=U(this.formModel,this.originalModel))},cancel(){return this.onFormCancel?this.onFormCancel():this.redirectPath?this.$router.push({path:this.redirectPath}):this.$router.previous?this.$router.push({...this.$router.previous}):this.$router.go(-1)},submit(){const e=this.entityName.toLowerCase(),i=this.isEditing?"updated":"created";if(!(this.$refs.entityForm&&this.$refs.entityForm.reportValidity()))return;this.transition("SUBMIT"),this.disabled=!0;const s=this.getModel();this.validateSchema(s).then(()=>this.onSubmit(s)).then(o=>this.handleSubmit(e,i,o)).catch(this.handleError)},confirm(){this.showConfirmationDialog?(this.transition("UPDATE"),this.disabled=!1,this.isModalOpen=!0,this.lang.MODAL_CONTENT={text:"Are you sure you want to proceed?",proceedText:`Update ${this.entityName}`}):this.submit()},dismissUpdate(){this.disabled=!1,this.transition("CANCEL"),this.lang.MODAL_CONTENT={text:null}},confirmDelete(){this.disabled=!1,this.transition("DELETE")},fetchSchema(){return this.$api.fetchSchema(this._schemaEndpoint)},validateSchema(e){return this.$api.validateSchema(this._schemaEndpoint,e)},handleLoad(e){if(e&&this.schema&&(e.data?(e.data.client_certificate=e.data.client_certificate&&e.data.client_certificate.id,this.updateModel(!1,e.data)):e.config&&((e.consumer_id||e.service_id||e.route_id)&&this.updateModel(!1,{service_id:e.service_id,route_id:e.route_id,consumer_id:e.consumer_id,enabled:e.enabled}),this.updateModel(!1,{enabled:e.enabled}),this.updateModel("config",e.config))),this.fields&&this.schema){const i={};Object.keys(this.fields).forEach(s=>{const o=s.replace("_","-");Object.prototype.hasOwnProperty.call(this.formModel,o)&&(i[o]=this.fields[s])}),this.updateModel(!1,i)}if(this.entityId&&this.schema){const i={};Object.prototype.hasOwnProperty.call(this.formModel,this.entityType)&&(i[this.entityType]=this.entityId.split(",")[0]),this.updateModel(!1,i)}this.transition("RESOLVE"),this.disabled=!1},handleSubmit(e,i,s){this.isEditing&&this.transition("RESOLVE"),this.isModalOpen=!1,this.originalModel=JSON.parse(JSON.stringify(this.formModel));const o=M(s,this.entity)||M(this.originalModel,this.entity)||M(this.formModel,this.entity)||"undefined";!this.preventNotify&&this.notify({message:`${o} ${e} successfully ${i}!`,type:"success"})},handleError(e){this.disabled=!1,e&&e.response&&e.response.status&&R(this.$router,404,"/404",{replace:!0})(e),this.transition("REJECT",{errorMessage:B(e)}),this.scrollToBottom()},updateModel(e,i){Object.keys(i).forEach(s=>{const o=e?`${e}-${s}`:s,n=this.schema[o],t=i[s],a=typeof t;if(n&&n.type==="object-advanced"&&!t){this.formModel[o]={},this.originalModel[o]={};return}if(Array.isArray(t)){this.formModel[o]=JSON.parse(JSON.stringify(t)),this.originalModel[o]=JSON.parse(JSON.stringify(t));return}if(a==="object"&&t&&!t.length)return this.updateModel(o,t);if(a==="object"&&t&&t.length&&n.type==="input"){this.formModel[o]=t.join(", "),this.originalModel[o]=t.join(", ");return}this.formModel[o]=t,this.originalModel[o]=t}),this.$emit("model-updated",this.formModel)},getModel(){const e={...this.schema},i=this.formModel,s=this.originalModel,o=Object.keys(i),n={};if(!F(this.formSchema))for(let t=0;t<this.formSchema.fields.length;t++)e[this.formSchema.fields[t].model]=this.formSchema.fields[t];return j.forEach(t=>{e[t]&&(e[t].fields.forEach(a=>{a.fields&&a.fields.forEach(r=>{e[r.model]=r}),a.model&&(e[a.model]=a)}),delete e[t])}),o.forEach(t=>{if(!e[t])return;const a=e[t];let r=i[t];const y=s[t],c=typeof r,h=a?a.valueType:null,p=a?a.valueArrayType:null,g=a?a.transform:null;if(r==null)return;if(a&&h&&c!==h)switch(h){case"array":c==="string"&&r.length&&(r=r.split(",").map(d=>{if(d=d.trim(),p==="string")return String(d);if(p==="number")return Number(d);if(p==="boolean"){if(typeof d=="string")return d.toLowerCase()==="true"||d==="1";if(typeof d=="number")return d===1}return d})),(!r||!r.length)&&(r=[]);break;case"number":r=Number(r);break;case"boolean":c==="string"&&(r=r.toLowerCase()==="true"||r==="1"),c==="number"&&(r=r===1);break;case"string":r=String(r);break}let l=J(t);if(h==="object-expand"){let d;[l,d]=l.split(".");const S={};S[d]=r,r=S}y!==void 0&&r===""&&r!==y?n[l]=h==="object"?{}:null:a.type==="checklist"&&r===""?n[l]=[]:r!==""&&(n[l]=r),n[l]=g?g(r):n[l],this.unsetNullForeignKey(l,n)}),V(n)},onModelUpdated(e,i){this.transition("RESOLVE");const s={[i]:e};this.formModel=Object.assign({},this.formModel,s),this.$emit("model-updated",this.formModel)},deleteModalFunc(e,i,s){return i(),this.onDelete(this.getModel(),s)},onDeleteTransition(e){switch(this.transition(e),this.disabled=!["RESOLVE","REJECT","CANCEL"].includes(e),e){case"RESOLVE":this.redirectPath?this.$router.replace(this.redirectPath):this.redirectRouteAfterDelete&&this.$router.replace(this.redirectRouteAfterDelete);break;case"CANCEL":this.checkUpdateable();break}}}},N={key:1,ref:"entityForm",class:"entity-form"},$={key:2,class:"error-message mb-4"},D={"data-testid":"form-footer-actions"},k=K(" Cancel ");function A(e,i,s,o,n,t){const a=u("KSkeleton"),r=u("VueFormGenerator"),y=u("KAlert"),c=u("EntityButton"),h=u("KButton"),p=u("ConfirmModalDialog"),g=u("EntityDeleteModal");return e.currentState==="pending"?(m(),b(a,{key:0,type:"form"})):(m(),T("form",N,[["pending"].includes(e.currentState)?f("",!0):C(e.$slots,"alertMessage",{key:0}),n.formModel.id&&s.isEditing||!s.isEditing?(m(),b(r,{key:1,schema:n.formSchema,model:n.formModel,options:n.formOptions,onModelUpdated:t.onModelUpdated},null,8,["schema","model","options","onModelUpdated"])):f("",!0),C(e.$slots,"afterFormContainer"),e.currentState==="error"?(m(),T("div",$,[E(y,{"alert-message":n.errorMessage,appearance:"danger"},null,8,["alert-message"])])):f("",!0),q("div",D,[E(c,{workspace:e.workspace,"restricted-actions":[t.isUpdating?"update":"create"],entity:`${s.resourceEndpoint}${t.isUpdating?`/${t.id}`:""}`,text:n.isModalOpen?s.buttonText:t.confirmButtonText,"button-props":{disabled:t.isSaveActionDisabled,appearance:"primary",class:"mr-2"},"is-loading":n.isModalOpen?!1:["submitting","confirm_delete"].includes(e.currentState),onClick:t.confirm},null,8,["workspace","restricted-actions","entity","text","button-props","is-loading","onClick"]),t.isAllowedToDelete?(m(),b(c,{key:0,workspace:e.workspace,"restricted-actions":["delete"],entity:`${s.resourceEndpoint}/${t.id}`,text:`Delete ${s.entityName}`,"button-props":{disabled:e.currentState==="confirm_delete",appearance:"danger",class:"float-right"},onClick:t.confirmDelete},null,8,["workspace","entity","text","button-props","onClick"])):f("",!0),E(h,{appearance:"outline","data-testid":"form-footer-action-cancel",onClick:t.cancel},{default:I(()=>[k]),_:1},8,["onClick"])]),s.showConfirmationDialog?(m(),b(p,{key:3,title:`Update ${s.entityName}`,"entity-name":s.entityName,visible:["submitting","confirm_update"].includes(e.currentState),text:n.lang.MODAL_CONTENT.text,"proceed-text":e.currentState==="submitting"?t.confirmButtonText:n.lang.MODAL_CONTENT.proceedText,"dismiss-text":n.lang.MODAL_CONTENT.dismissText,disabled:n.disabled,"is-loading":["submitting","deleting"].includes(e.currentState),action:"update",onOk:i[0]||(i[0]=l=>t.submit()),onCancel:i[1]||(i[1]=l=>t.dismissUpdate())},null,8,["title","entity-name","visible","text","proceed-text","dismiss-text","disabled","is-loading"])):f("",!0),E(g,{"model-value":t.deleteModalModel,"entity-name":s.entityName,entity:s.entity,disabled:n.disabled,"delete-func":s.onDelete&&t.deleteModalFunc,loading:["submitting","deleting"].includes(e.currentState),class:"defaultModal",onDelete:i[2]||(i[2]=l=>t.onDeleteTransition("SUBMIT")),onAfterDelete:i[3]||(i[3]=l=>t.onDeleteTransition("RESOLVE")),onError:i[4]||(i[4]=l=>t.onDeleteTransition("REJECT")),onDismiss:i[5]||(i[5]=l=>t.onDeleteTransition("CANCEL"))},null,8,["model-value","entity-name","entity","disabled","delete-func","loading"])],512))}_=P(O,[["render",A]])});export{_ as N,ee as __tla};
