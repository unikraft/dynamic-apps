/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{a9 as $,g as w,aa as x,m as C,n as v,Y as N,a1 as j,a6 as F,a7 as U,_ as L,r as u,o as c,l as y,c as D,a as B,ab as J,h as p,G as P,b as M,w as W,j as q,d as K,__tla as R}from"./index.84d84090.3_3_0_0.js";import{C as I,__tla as G}from"./ConfirmModalDialog.af276128.3_3_0_0.js";import{E as V,__tla as Y}from"./EntityDeleteModal.673d985c.3_3_0_0.js";import{E as Z,__tla as z}from"./EntityMixin.2764673d.3_3_0_0.js";import{R as H}from"./RedirectMixin.efeb36f2.3_3_0_0.js";let S,Q=Promise.all([(()=>{try{return R}catch{}})(),(()=>{try{return G}catch{}})(),(()=>{try{return Y}catch{}})(),(()=>{try{return z}catch{}})()]).then(async()=>{const T={name:"EntityForm",components:{ConfirmModalDialog:I,EntityDeleteModal:V,...$},mixins:[Z,H],props:{entity:{type:String,default:""},entityName:{type:String,default:""},redirectRouteAfterDelete:{type:Object,default:null},entityWorkspace:{type:String,default:""},buttonText:{type:String,default:""},schema:{type:Object,default:()=>({})},fields:{type:Object,default:()=>({})},onLoad:{type:Function,default:()=>new Promise(e=>e(!1))},onSubmit:{type:Function,default:()=>{}},showDelete:{type:Boolean,default:!0},onDelete:{type:Function,default:()=>{}},onFormCancel:{type:Function,default:null},isEditing:{type:Boolean,default:!1},showConfirmationDialog:{type:Boolean,default:!1},preventSubmissionBeforeChange:{type:Boolean,default:!0},preventNotify:{type:Boolean,required:!1,default:!1},resourceEndpoint:{type:String,required:!0},errorMessage:{type:Function,default:w},deleteModalText:{type:String,default:""},enableSubmit:{type:Boolean,default:!1},hideSubmit:{type:Boolean,default:!1}},emits:["clicked-submit","model-updated"],data(){const e=this.parseSchema();return{disabled:!1,loading:!1,confirming:!1,confirmingDelete:!1,isModalOpen:!1,deleting:!1,pending:!1,error:!1,originalModel:JSON.parse(JSON.stringify(e.model)),formModel:e.model,formSchema:e.schema,formOptions:e.options,sharedFormName:null,lang:{MODAL_CONTENT:{text:null,proceedText:null,dismissText:null}}}},computed:{isUpdating(){return this.buttonText.toLowerCase()==="save"},confirmButtonText(){return this.loading?"Loading...":this.pending?"Submitting...":this.deleting?"Deleting...":this.buttonText},id(){return this.$route.params.id||this.formModel.id},isAllowedToUpdate(){return this.$rbac.isAllowed(this.perms,[{path:`/${this.resourceEndpoint}/${this.id||"*"}`,actions:["update"]}],this.entityWorkspace||this.workspace)},isAllowedToCreate(){return this.$rbac.isAllowed(this.perms,[{path:`/${this.resourceEndpoint}/`,actions:["create"]}],this.entityWorkspace||this.workspace)},isAllowedToDelete(){return this.showDelete&&this.isEditing},entityId(){return this.$route&&this.$route.query&&this.$route.query.entity_id},entityType(){return this.$route&&this.$route.query&&this.$route.query.entity_type.replace("_","-")},deleteModalModel(){return this.confirmingDelete||this.deleting?{record:this.originalModel}:null},isSaveActionDisabled(){return!this.isModalOpen||this.disabled?this.disabled:!1}},watch:{formModel:{handler:function(){const e=this.isUpdating?this.isAllowedToUpdate:this.isAllowedToCreate;this.formSchema={fields:this.formSchema.fields.map(n=>({...n,disabled:n.disabled||!e}))},this.preventSubmissionBeforeChange&&(this.compareModels(this.formModel,this.originalModel)?this.disabled=!0:this.disabled=!1)},deep:!0},schema:{handler:function(){const e=this.parseSchema(),n=this.isUpdating?this.isAllowedToUpdate:this.isAllowedToCreate;this.formModel=e.model,this.formSchema={fields:e.schema.fields.map(o=>({...o,disabled:o.disabled||!n}))},this.originalModel=JSON.parse(JSON.stringify(e.model)),this.sharedFormName=x(e.model.name),this.load()},immediate:!0},enableSubmit:{handler:function(){this.isEditing&&(this.disabled=!this.enableSubmit)}}},methods:{...C(v,["notify"]),load(){this.loading=!0,this.disabled=!0,this.onLoad().then(e=>this.handleLoad(e)).catch(this.handleError)},cancel(){this.onFormCancel?this.onFormCancel():this.redirectPath?this.$router.push({path:this.redirectPath}):this.$router.previous?this.$router.push({...this.$router.previous}):this.$router.go(-1)},submit(){const e=this.entityName.toLowerCase(),n=this.isEditing?"updated":"created";if(this.pending=!0,this.disabled=!0,this.error=!1,this.confirming=!1,this.hideSubmit)return this.$emit("clicked-submit",{data:this.getModel(),submitAction:this.onSubmit});this.onSubmit(this.getModel()).then(o=>this.handleSubmit(e,n,o)).catch(this.handleError)},confirm(e){e&&e.target.type==="textarea"||(e&&(this.isUpdating||e.cancelable)&&e.preventDefault(),this.showConfirmationDialog?(this.isModalOpen=!0,this.confirming=!0,this.lang.MODAL_CONTENT={text:"Are you sure you want to proceed?",proceedText:`Update ${this.entityName}`}):this.submit())},dismissUpdate(){this.pending=!1,this.disabled=!1,this.confirming=!1,this.lang.MODAL_CONTENT={text:null}},confirmDelete(){this.error=!1,this.isModalOpen=!0,this.confirmingDelete=!0,this.lang.MODAL_CONTENT={text:this.deleteModalText,proceedText:`Delete ${this.entityName}`}},dismissDelete(){this.pending=!1,this.disabled=!1,this.confirmingDelete=!1,this.lang.MODAL_CONTENT={text:null}},handleLoad(e){if(e&&this.schema&&(e.data?this.updateModel(!1,e.data):e.config&&((e.consumer_id||e.service_id||e.route_id)&&this.updateModel(!1,{service_id:e.service_id,route_id:e.route_id,consumer_id:e.consumer_id,enabled:e.enabled}),this.updateModel(!1,{enabled:e.enabled}),this.updateModel("config",e.config))),this.fields&&this.schema){const n={};Object.keys(this.fields).forEach(o=>{const a=o.replace("_","-");Object.prototype.hasOwnProperty.call(this.formModel,a)&&(n[a]=this.fields[o])}),this.updateModel(!1,n)}if(this.entityId&&this.schema){const n={};Object.prototype.hasOwnProperty.call(this.formModel,this.entityType)&&(n[this.entityType]=this.entityId.split(",")[0]),this.updateModel(!1,n)}this.loading=!1,this.disabled=!1},handleSubmit(e,n,o){this.isEditing&&(this.disabled=!1),this.isModalOpen=!1,this.deleting=!1,this.pending=!1,this.originalModel=JSON.parse(JSON.stringify(this.formModel));const a=N(o,this.entity)||N(this.originalModel,this.entity)||N(this.formModel,this.entity)||"undefined";!this.preventNotify&&this.notify({message:`${a} ${e} successfully ${n}!`,type:"success"})},handleError(e){this.pending=!1,this.disabled=!1,this.error=this.errorMessage(e),this.scrollToBottom()},compareModels(e,n){return JSON.stringify(e)===JSON.stringify(n)},updateModel(e,n){Object.keys(n).forEach(o=>{const a=e?`${e}-${o}`:o,i=this.schema[a],t=n[o],r=typeof t;if(i&&i.type==="object-advanced"&&!t){this.formModel[a]={},this.originalModel[a]={};return}if(Array.isArray(t)){this.formModel[a]=JSON.parse(JSON.stringify(t)),this.originalModel[a]=JSON.parse(JSON.stringify(t));return}if(r==="object"&&t&&!t.length)return this.updateModel(a,t);if(r==="object"&&t&&t.length&&i.type==="input"){this.formModel[a]=t.join(", "),this.originalModel[a]=t.join(", ");return}this.formModel[a]=t,this.originalModel[a]=t}),this.$emit("model-updated",this.formModel,this.originalModel)},getModel(){const e={...this.schema},n=this.formModel,o=this.originalModel,a=Object.keys(n),i={};return j.forEach(t=>{e[t]&&(e[t].fields.forEach(r=>{r.fields&&r.fields.forEach(s=>{e[s.model]=s}),r.model&&(e[r.model]=r)}),delete e[t])}),a.forEach(t=>{if(!e[t])return;const r=e[t];let s=n[t];const f=o[t],m=Array.isArray(s)?"array":typeof s,h=r?r.valueType:null,g=r?r.valueArrayType:null,b=r?r.transform:null;if(s==null&&f==null&&!r.submitWhenNull)return;if(r){if(h&&m!==h)switch(h){case"array":m==="string"&&s.length&&(s=s.split(",").map(l=>{if(l=l.trim(),g==="string")return String(l);if(g==="number")return Number(l);if(g==="boolean"){if(typeof l=="string")return l.toLowerCase()==="true"||l==="1";if(typeof l=="number")return l===1}return l})),(!s||!s.length)&&(s=r.submitWhenNull?null:[]);break;case"number":s=Number(s);break;case"boolean":m==="string"&&(s=s.toLowerCase()==="true"||s==="1"),m==="number"&&(s=s===1);break;case"string":s=s==null?"":String(s);break}else h==="array"&&(!s||!s.length)&&(s=r.submitWhenNull?null:[]);r.type==="object-advanced"&&r.fields&&s!==null&&(Object.entries(s).length===0?s=null:Object.keys(s).forEach(l=>{Array.isArray(s[l])||(s[l]=s[l].split(","))}))}let d=F(t);if(h==="object-expand"){let l;[d,l]=d.split(".");let O={};i[d]&&(O=i[d]),O[l]=s,s=O}f!==void 0&&s===""&&s!==f?i[d]=h==="object"?{}:null:r.type==="checklist"&&s===""?i[d]=[]:s!==""&&(i[d]=s),i[d]=b?b(s):i[d],this.unsetNullForeignKey(d,i)}),U(i)},onModelUpdated(e,n){const o={[n]:e};this.formModel=Object.assign({},this.formModel,o),this.$emit("model-updated",this.formModel,this.originalModel)},deleteModalFunc(e,n,o){return n(),this.onDelete(this.getModel(),o)},onAfterDelete(){this.postDeletePath?this.$router.replace(this.postDeletePath):this.redirectPath?this.$router.replace(this.redirectPath):this.redirectRouteAfterDelete&&this.$router.replace(this.redirectRouteAfterDelete)}}},_={key:2,"data-testid":"form-footer-actions"},k={key:0,class:"error-message mb-4"},E=K(" Cancel ");function A(e,n,o,a,i,t){const r=u("KSkeleton"),s=u("VueFormGenerator"),f=u("KAlert"),m=u("EntityButton"),h=u("KButton"),g=u("ConfirmModalDialog"),b=u("EntityDeleteModal");return i.loading?(c(),y(r,{key:0,type:"form"})):(c(),D("div",{key:1,ref:"entityForm",class:"entity-form",onKeydown:n[3]||(n[3]=q((...d)=>t.confirm&&t.confirm(...d),["enter"]))},[B("form",{hidden:"",onSubmit:n[0]||(n[0]=(...d)=>t.confirm&&t.confirm(...d))},null,32),i.sharedFormName&&(i.formModel.id&&o.isEditing||!o.isEditing)?(c(),y(J(i.sharedFormName),{key:0,"form-schema":i.formSchema,"form-model":i.formModel,"form-options":i.formOptions,"on-model-updated":t.onModelUpdated,"is-editing":o.isEditing},null,40,["form-schema","form-model","form-options","on-model-updated","is-editing"])):p("",!0),!i.sharedFormName&&(i.formModel.id&&o.isEditing||!o.isEditing)?(c(),y(s,{key:1,schema:i.formSchema,model:i.formModel,options:i.formOptions,onModelUpdated:t.onModelUpdated},null,8,["schema","model","options","onModelUpdated"])):p("",!0),P(e.$slots,"afterFormContainer"),o.hideSubmit?p("",!0):(c(),D("div",_,[i.error?(c(),D("div",k,[M(f,{"alert-message":i.error,appearance:"danger"},null,8,["alert-message"])])):p("",!0),M(m,{workspace:o.entityWorkspace||e.workspace,"restricted-actions":[t.isUpdating?"update":"create"],entity:`${o.resourceEndpoint}${t.isUpdating?`/${t.id}`:""}`,text:i.isModalOpen?o.buttonText:t.confirmButtonText,"button-props":{disabled:t.isSaveActionDisabled,appearance:"primary",class:"mr-2"},"is-loading":i.pending&&!i.isModalOpen,onClick:t.confirm},null,8,["workspace","restricted-actions","entity","text","button-props","is-loading","onClick"]),t.isAllowedToDelete?(c(),y(m,{key:1,workspace:o.entityWorkspace||e.workspace,"restricted-actions":["delete"],entity:`${o.resourceEndpoint}/${t.id}`,text:`Delete ${o.entityName}`,"button-props":{disabled:i.deleting,appearance:"danger",class:"float-right"},onClick:t.confirmDelete},null,8,["workspace","entity","text","button-props","onClick"])):p("",!0),M(h,{"data-testid":"form-footer-action-cancel",appearance:"outline",onClick:t.cancel},{default:W(()=>[E]),_:1},8,["onClick"])])),o.showConfirmationDialog?(c(),y(g,{key:3,title:`Update ${o.entityName}`,"entity-name":o.entityName,visible:i.confirming||i.pending,text:i.lang.MODAL_CONTENT.text,"proceed-text":i.pending?t.confirmButtonText:i.lang.MODAL_CONTENT.proceedText,"dismiss-text":i.lang.MODAL_CONTENT.dismissText,"is-loading":i.pending,disabled:i.pending,action:"update",onOk:n[1]||(n[1]=d=>t.submit()),onCancel:n[2]||(n[2]=d=>t.dismissUpdate())},null,8,["title","entity-name","visible","text","proceed-text","dismiss-text","is-loading","disabled"])):p("",!0),M(b,{"model-value":t.deleteModalModel,"entity-name":o.entityName,entity:o.entity,"delete-func":o.onDelete&&t.deleteModalFunc,loading:i.deleting,disabled:i.deleting,class:"defaultModal",onAfterDelete:t.onAfterDelete,onDismiss:t.dismissDelete},null,8,["model-value","entity-name","entity","delete-func","loading","disabled","onAfterDelete","onDismiss"])],544))}S=L(T,[["render",A]])});export{S as E,Q as __tla};
