/*
  This software is copyright Kong Inc. and its licensors.
  Use of the software is subject to the agreement between your organization
  and Kong Inc. If there is no such agreement, use is governed by and
  subject to the terms of the Kong Master Software License Agreement found
  at https://konghq.com/enterprisesoftwarelicense/.
*/

import{m as R,n as F,g as h,_ as x,r as o,o as d,c as g,b as l,H as ae,N as oe,T as re,z as ce,Q as le,a4 as de,a8 as L,w as c,l as m,a as u,F as pe,h as _,d as f,p as me,e as ue,__tla as he}from"./index.84d84090.3_3_0_0.js";import{E as S,__tla as _e}from"./EntityForm.c5492e4f.3_3_0_0.js";import{F as C,__tla as be}from"./FormPage.4b74a91a.3_3_0_0.js";import{E as ye,__tla as ge}from"./EmptyWrapper.df2b9a4e.3_3_0_0.js";import{K as fe,__tla as ve}from"./KEntityList.599bcd88.3_3_0_0.js";import{C as Ee,__tla as ke}from"./ConfirmModalDialog.af276128.3_3_0_0.js";import{s as v}from"./AdminEndpoint.ee719c99.3_3_0_0.js";import{__tla as we}from"./monaco-editor.90904fcf.3_3_0_0.js";import{__tla as Re}from"./EntityDeleteModal.673d985c.3_3_0_0.js";import{__tla as Fe}from"./EntityMixin.2764673d.3_3_0_0.js";import{__tla as xe}from"./EntityButton.1838e0e9.3_3_0_0.js";import{__tla as Le}from"./EntityFilter.bf4158bc.3_3_0_0.js";import"./RedirectMixin.efeb36f2.3_3_0_0.js";import{__tla as Se}from"./KDataProvider.78c9bca8.3_3_0_0.js";import{__tla as Ce}from"./preferences.ea825a88.3_3_0_0.js";let $,$e=Promise.all([(()=>{try{return he}catch{}})(),(()=>{try{return _e}catch{}})(),(()=>{try{return be}catch{}})(),(()=>{try{return ge}catch{}})(),(()=>{try{return ve}catch{}})(),(()=>{try{return ke}catch{}})(),(()=>{try{return we}catch{}})(),(()=>{try{return Re}catch{}})(),(()=>{try{return Fe}catch{}})(),(()=>{try{return xe}catch{}})(),(()=>{try{return Le}catch{}})(),(()=>{try{return Se}catch{}})(),(()=>{try{return Ce}catch{}})()]).then(async()=>{const E=["*","/","/acls","/acls/*","/acls/*/consumer","/admins","/admins/*","/admins/*/roles","/admins/*/workspaces","/admins/password_resets","/admins/register","/applications","/applications/*","/applications/*/application_instances","/applications/*/application_instances/*","/applications/*/credentials/*","/applications/*/credentials/*/*","/audit/objects","/audit/requests","/basic-auths/","/basic-auths/*/consumer","/cache","/cache/*","/ca_certificates","/ca_certificates/*","/certificates/","/certificates/*","/consumers/","/consumers/*","/consumers/*/acls","/consumers/*/acls/*","/consumers/*/basic-auth","/consumers/*/basic-auth/*","/consumers/*/jwt","/consumers/*/jwt/*","/consumers/*/hmac-auth","/consumers/*/hmac-auth/*","/consumers/*/key-auth","/consumers/*/key-auth/*","/consumers/*/plugins","/consumers/*/plugins/*","/consumers/*/consumer_groups","/consumers/*/consumer_groups/*","/consumer_groups/","/consumer_groups/*","/consumer_groups/*/consumers/","/consumer_groups/*/consumers/*","/consumer_groups/*/overrides/plugins/rate-limiting-advanced","/developers","/developers/*","/developers/*/applications","/developers/*/applications/*","/developers/*/applications/*/credentials/*","/developers/*/applications/*/credentials/*/*","/developers/*/applications/*/application_instances","/developers/*/applications/*/application_instances/*","/developers/*/*","/developers/invite","/developers/roles","/developers/roles/*","/groups","/groups/*/roles","/files","/files/*","/hmac-auths/","/hmac-auths/*/consumer","/key-auths/","/key-auths/*/consumer","/kong","/oas-config","/oauth2/*","/oauth2_tokens/","/oauth2_tokens/*","/plugins","/plugins/*","/plugins/enabled","/rbac/*","/rbac/*/*","/rbac/*/*/*","/rbac/*/*/*/*","/rbac/*/*/*/*/*","/rbac/roles","/rbac/roles/*","/rbac/roles/*/endpoints","/rbac/roles/*/endpoints/*/*","/rbac/roles/*/endpoints/permissions","/rbac/roles/*/entities","/rbac/roles/*/entities/*","/rbac/roles/*/entities/permissions","/rbac/roles/*/permissions","/rbac/users/","/rbac/users/*","/rbac/users/*/permissions","/rbac/users/*/roles","/routes","/routes/*","/routes/*/plugins","/routes/*/service","/schemas/*","/schemas/*/validate","/schemas/consumers","/schemas/consumers/validate","/services","/services/*","/services/*/document_objects","/services/*/applications","/services/*/application_instances","/services/*/application_instances/*","/services/*/plugins","/services/*/routes","/snis/","/snis/*","/status","/upstreams/","/upstreams/*","/upstreams/*/health/","/upstreams/*/targets/","/upstreams/*/targets/*","/upstreams/*/targets/*/healthy","/upstreams/*/targets/*/unhealthy","/upstreams/*/targets/all","/keys","/keys/*","/key-sets","/key-sets/*","/key-sets/*/keys","/key-sets/*/keys/*","/vitals/","/vitals/cluster","/vitals/cluster/status_codes","/vitals/consumers/*/cluster","/vitals/nodes/","/vitals/nodes/*","/vitals/status_code_classes","/vitals/status_codes/by_consumer","/vitals/status_codes/by_consumer_and_route","/vitals/status_codes/by_route","/vitals/status_codes/by_service","/workspaces/","/workspaces/*","/workspaces/*/entities","/workspaces/*/entities/*","/workspaces/*/meta","/vaults","/vaults/*"],I={name:"AdminEndpointForm",components:{EntityForm:S},mixins:[C],props:{redirect:{type:String,default:""},onFormCancel:{type:Function,default:()=>{}}},data(){return{resourceEndpoint:"rbac/roles/*/endpoints",schema:v}},computed:{redirectRoute(){return{name:this.redirect}}},beforeMount(){E.sort(),this.schema.endpoint.values=E||[]},methods:{...R(F,["notify"]),onLoad(){return Promise.resolve(!0)},handleError(e){return this.notify({message:h(e),type:"danger"})},onFormSubmit(e){return this.onFormCancel(e)}}},M={class:"admin-permission-form"};function T(e,s,i,a,n,t){const r=o("EntityForm");return d(),g("section",M,[l(r,{"is-editing":e.isEditing,"show-confirmation-dialog":!1,"prevent-notify":!0,"prevent-submission-before-change":e.isEditing,schema:n.schema,"on-load":t.onLoad,"on-submit":t.onFormSubmit,"on-delete":null,"on-form-cancel":i.onFormCancel,"resource-endpoint":n.resourceEndpoint,"button-text":"Add Permission to Role","entity-name":"permission"},null,8,["is-editing","prevent-submission-before-change","schema","on-load","on-submit","on-form-cancel","resource-endpoint"])])}const D=x(I,[["render",T]]),O={name:{type:"input",inputType:"text"},comment:{type:"input",inputType:"text"}},P={name:"RoleForm",components:{EntityForm:S,PageHeader:ae,EndpointForm:D,KEntityList:fe,EmptyWrapper:ye,ConfirmModalDialog:Ee},mixins:[C,oe,re],data(){return{schema:O,resourceEndpoint:"rbac/roles",endpointsUrl:"rbac/roles/:name_or_id/endpoints",isVisible:!1,tableSettings:{hasHover:!0,options:{headers:[{label:"",key:"negative",hideLabel:!0},{label:"Endpoint",key:"endpoint"},{label:"Actions",key:"actions"},{label:"",key:"customActions",hideLabel:!0}],data:[]}},deleteItem:!1,machine:this.fetchMachine("endpointsList")}},computed:{...ce(le,{docsBase:"docsEnterprise"}),breadcrumbItems(){const e=[{key:"teams-overview",to:{path:"/teams",hash:"#roles"},title:"Team Roles",text:"Teams"},{key:"workspace-roles",to:{name:"workspace-roles",params:{workspace:this.workspace}},title:`${this.workspace} Roles`,text:"Workspace Roles"}];return this.isEditing&&e.push({key:"teams-view-role",to:{name:"teams-view-role",params:{workspace:this.workspace,id:this.id}},title:this.id,text:"View Role"}),e},docsLink(){const e=this.isEditing?"#update-a-role":"#add-a-role";return`${this.docsBase.url}admin-api/rbac/reference/${e}`},id(){return this.$route.params.id},workspace(){return this.$route.params.workspace},returnLink(){return this.$router.navigateUp(1,!1)},redirectRoute(){return{name:"workspace-roles",params:{workspace:this.$route.params.workspace}}},entityListOptions(){return{entityName:"Endpoint",entity:this.isEditing&&this.id?this.endpointsUrl.replace(":name_or_id",this.id):null,fields:{...v}}},emptyData(){return this.tableSettings.options.data&&this.tableSettings.options.data.length===0}},created(){this.transition("FETCH"),this.isEditing||this.transition("RESOLVE")},methods:{...R(F,["notify"]),openEndpointModal(){this.isVisible=!0},closeModal(e){if(!e||!Object.values(e).reduce((n,t)=>n+t)){this.isVisible=!1;return}let s=!1;const i=[],a=e.endpoint?e.endpoint.split(","):[];return e.custom_endpoint&&a.push(e.custom_endpoint),a.forEach(n=>{e.negative=e.custom_endpoint===n?e.custom_negative:e.negative,e.actions=e.custom_endpoint===n?e.custom_actions:e.actions;const t={...e,endpoint:n};s=this.tableSettings.options.data.find(r=>v.comparator(r,t)),s||i.push(this.addEndpoint(t))}),new Promise((n,t)=>{if(s)return this.notify({message:"Permissions for this endpoint already exist.",type:"danger"}),t();this.isVisible=!1,this.isEditing&&Promise.all(i).then(r=>{r.forEach(y=>this.tableSettings.options.data.push(y.data)),this.refreshEndpointsTable(),this.notify({message:"Endpoints submission successful!",type:"success"})}).catch(r=>{this.refreshEndpointsTable(),this.notify({message:h(r),type:"danger"})}),n(this.tableSettings.options.data)})},addEndpoint(e){if(Object.values(e).reduce((s,i)=>s+i)){if(this.isEditing){const s=e.endpoint,i=e.actions,a=e.negative;return this.createEndpoint(this.id,s,i,a)}return this.tableSettings.options.data.push({...e})}this.notify({message:"Endpoint add unsuccessful.",type:"danger"})},removeEndpoint(){const e=this.deleteItem.row,s=this.deleteItem.rowKey;if(this.isEditing){e.endpoint=e.endpoint[0]==="/"?e.endpoint.slice(1,e.endpoint.length):e.endpoint,this.deleteEndpoint(e).then(()=>this.tableSettings.options.data.splice(s,1)).catch(i=>this.notify({message:h(i),type:"danger"}));return}this.tableSettings.options.data.splice(s,1),this.deleteItem=null},saveEndpoints(e,s){const i=[];return e.forEach(a=>{const{actions:n,negative:t}=a;a.endpoint.split(",").forEach(r=>{i.push(this.createEndpoint(s,r,n,t))})}),i},createEndpoint(e,s,i,a){return this.$api.createRecord(this.endpointsUrl.replace(":name_or_id",e),{endpoint:s,actions:i,negative:a})},deleteEndpoint(e){return this.$api.deleteWithBody(`rbac/roles/${e.role.id}/endpoints/${e.workspace}/${e.endpoint}`,{}).then(()=>(this.deleteItem=null,de(this.$router,204,this.$router.currentRoute.value.fullPath,{replace:!0}))).catch(s=>{throw this.deleteItem=null,s})},refreshEndpointsTable(){this.$refs.endpointList.triggerReload()},async onFormSubmit(e){if(this.isEditing)return this.updateRecord(e);const s=(await this.$api.createRecord(this.resourceEndpoint,e)).data,i=this.saveEndpoints(this.tableSettings.options.data,s.id);Promise.all(i).then(()=>{L.trackEvent(L.EVENTS.ROUTE_ADDED),this.$router.push(this.redirectRoute)}).catch(a=>this.notify({message:h(a),type:"danger"}))},confirmDeleteItem(e,s){this.deleteItem={row:e,rowKey:s}},dismissDeleteItem(){this.deleteItem=null}}},b=e=>(me("data-v-5a183207"),e=e(),ue(),e),A={class:"container role-form"},K=f(" View docs "),V={class:"my-3"},N=b(()=>u("label",null,"Permissions",-1)),j=f(" Add permission "),B={class:"endpoint-list"},H={key:0,class:"d-flex align-items-center"},U=b(()=>u("i",{class:"text-danger material-icons"},"not_interested",-1)),W=b(()=>u("i",{class:"text-muted material-icons"},"done",-1)),z={class:"endpointFormModal"},q=f(" Add Permissions to Role ");function J(e,s,i,a,n,t){const r=o("KBreadcrumbs"),y=o("KExternalLink"),Q=o("PageHeader"),G=o("ConfirmModalDialog"),k=o("KButton"),w=o("KTooltip"),X=o("KIcon"),Y=o("KEntityList"),Z=o("EmptyWrapper"),ee=o("EntityForm"),te=o("EndpointForm"),se=o("KModal");return d(),g("section",A,[l(r,{items:t.breadcrumbItems},null,8,["items"]),l(Q,null,{default:c(()=>[l(y,{href:t.docsLink},{default:c(()=>[K]),_:1},8,["href"])]),_:1}),l(G,{title:`Delete ${t.entityListOptions.entityName}`,"entity-name":t.entityListOptions.entityName,visible:!!n.deleteItem,action:"delete",class:"customModal",onOk:t.removeEndpoint,onCancel:t.dismissDeleteItem},null,8,["title","entity-name","visible","onOk","onCancel"]),l(ee,{"is-editing":e.isEditing,"show-confirmation-dialog":!1,"prevent-submission-before-change":e.isEditing,schema:n.schema,"button-text":e.buttonText,"on-load":e.onFormLoad,"on-submit":t.onFormSubmit,"on-delete":e.onDeleteWhenEditing,"resource-endpoint":n.resourceEndpoint,"redirect-route-after-delete":{name:"workspace-roles"},"entity-name":"Role",entity:"rbac/roles"},{afterFormContainer:c(()=>[u("div",V,[N,e.currentMachineState.matches("success")&&!t.emptyData?(d(),m(k,{key:0,class:"mb-4 float-right",appearance:"outline",onClick:t.openEndpointModal},{default:c(()=>[j]),_:1},8,["onClick"])):_("",!0)]),u("div",B,[l(Y,{ref:"endpointList","table-settings":n.tableSettings,"entity-name":t.entityListOptions.entityName,"resource-url":t.entityListOptions.entity,"show-update-action":!1,onResolve:s[0]||(s[0]=p=>e.transition("RESOLVE")),onError:s[1]||(s[1]=p=>e.transition("REJECT"))},{"entity-negative":c(({row:p})=>[p?(d(),g("div",H,[p.negative?(d(),m(w,{key:0,label:"[Negative] endpoint. Role will NOT be able to access this endpoint.",position:"top",alignment:"center"},{default:c(()=>[U]),_:1})):(d(),m(w,{key:1,label:"Role will have access to this endpoint",position:"top",alignment:"center"},{default:c(()=>[W]),_:1}))])):_("",!0)]),"entity-customActions":c(({row:p,rowKey:ie,rbac:ne})=>[ne.isAllowedToDelete?(d(),m(k,{key:0,class:"float-right delete",appearance:"btn-link",onClick:Ie=>t.confirmDeleteItem(p,ie)},{icon:c(()=>[l(X,{"view-box":"0 0 18 18",icon:"trash",size:"18"})]),_:2},1032,["onClick"])):_("",!0)]),_:1},8,["table-settings","entity-name","resource-url"])]),e.currentMachineState.matches("success")&&t.emptyData?(d(),m(Z,{key:0,"handle-click":t.openEndpointModal,class:"mb-4",title:"No RBAC Role endpoints have been created",message:"Create endpoints to grant or restrict access to entities.","cta-text":"Add Permission"},null,8,["handle-click"])):_("",!0)]),_:1},8,["is-editing","prevent-submission-before-change","schema","button-text","on-load","on-submit","on-delete","resource-endpoint"]),(d(),m(pe,{to:"#app"},[u("div",z,[l(se,{"is-visible":n.isVisible,"text-align":"left",title:"Add Permissions to Role","tabbable-options":e.tabbableOptions,onCanceled:t.closeModal},{"header-content":c(()=>[q]),"body-content":c(()=>[l(te,{id:t.id,"on-success":t.closeModal,"on-form-cancel":t.closeModal,redirect:"admins"},null,8,["id","on-success","on-form-cancel"])]),_:1},8,["is-visible","tabbable-options","onCanceled"])])]))])}$=x(P,[["render",J],["__scopeId","data-v-5a183207"]])});export{$e as __tla,$ as default};
